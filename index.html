<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pro Pricing Calculator</title>
  <style>
    :root {
      --system-bg: #f5f5f7;
      --card-bg: rgba(255, 255, 255, 0.75);
      --primary-blue: #0071e3;
      --text-primary: #1d1d1f;
      --text-secondary: #86868b;
      --divider: rgba(0, 0, 0, 0.1);
      --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
      --radius-lg: 24px;
      --radius-sm: 12px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: url('https://images.unsplash.com/photo-1614850523459-c2f4c699c52e?q=80&w=2070&auto=format&fit=crop') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      padding: 20px;
      box-sizing: border-box;
    }

    .calculator-card {
      background: var(--card-bg);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      width: 100%;
      max-width: 440px;
      padding: 34px 26px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      box-sizing: border-box;
      border: 1px solid rgba(255, 255, 255, 0.6);
      margin-top: 20px;
      transition: max-width 0.4s ease, padding 0.4s ease;
    }

    h2 {
      text-align: center;
      font-weight: 650;
      font-size: 1.5rem;
      margin: 0 0 26px 0;
      letter-spacing: -0.5px;
      color: #111;
    }

    .calc-layout-grid {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* 桌面：三列等高（关键） */
    @media (min-width: 980px) {
      .calculator-card {
        max-width: 1180px;
        padding: 46px;
      }

      .calc-layout-grid {
        display: grid;
        grid-template-columns: 0.82fr 1.08fr 0.95fr;
        gap: 28px;
        align-items: stretch; /* 关键：拉伸到同高 */
      }

      h2 {
        grid-column: 1 / -1;
        margin-bottom: 18px;
        font-size: 1.9rem;
      }

      .divider-mobile { display: none; }
    }

    .divider-mobile {
      height: 1px;
      background: var(--divider);
      margin: 6px 0;
    }

    /* ===== 三列主模块统一容器（关键） ===== */
    .panel-card {
      background: rgba(255,255,255,0.28);
      padding: 18px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.55);
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      height: 100%;
      box-sizing: border-box;
    }
    @media (min-width: 980px) {
      .panel-card { padding: 22px; }
    }

    .input-group { margin-bottom: 22px; }

    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .segmented-control {
      display: flex;
      background: rgba(118, 118, 128, 0.12);
      padding: 2px;
      border-radius: 8px;
      width: 120px;
    }

    .segment-btn {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 0.75rem;
      font-weight: 550;
      padding: 4px 0;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .segment-btn.active {
      background: white;
      box-shadow: 0 3px 8px rgba(0,0,0,0.12), 0 3px 1px rgba(0,0,0,0.04);
      font-weight: 650;
    }

    .input-wrapper {
      position: relative;
      background: rgba(255, 255, 255, 0.6);
      border-radius: var(--radius-sm);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
      transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    .input-wrapper:focus-within, .input-wrapper.active-wrapper {
      box-shadow: inset 0 0 0 2px var(--primary-blue);
      background: #fff;
    }

    input[type="number"] {
      width: 100%;
      border: none;
      background: transparent;
      padding: 14px 16px;
      font-size: 1.1rem;
      font-weight: 400;
      border-radius: var(--radius-sm);
      outline: none;
      box-sizing: border-box;
      font-family: inherit;
      color: #000;
    }

    .unit-label {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 0.9rem;
      pointer-events: none;
    }

    .preset-group {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .preset-btn {
      flex: 1;
      min-width: 55px;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(0,0,0,0.05);
      border-radius: 8px;
      padding: 8px 0;
      font-size: 0.75rem;
      font-weight: 520;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .preset-btn:hover { background: rgba(255, 255, 255, 0.9); }
    .preset-btn:active { transform: scale(0.96); }

    .results-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 18px;
    }

    .result-box {
      background: rgba(255,255,255,0.82);
      padding: 18px;
      border-radius: 16px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.85);
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    }

    .res-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: block;
      margin-bottom: 6px;
    }

    .res-value {
      font-size: 1.35rem;
      font-weight: 650;
      letter-spacing: -0.5px;
      white-space: nowrap;
    }

    .cny-val { color: #ff3b30; }
    .usd-val { color: #34c759; }

    .virtual-keypad {
      background: rgba(230, 230, 235, 0.8);
      backdrop-filter: blur(10px);
      padding: 8px;
      border-radius: 16px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .key-btn {
      background: rgba(255,255,255,0.95);
      border: none;
      border-radius: 8px;
      height: 52px;
      font-size: 1.25rem;
      font-weight: 420;
      color: #000;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,0.15);
      transition: background 0.1s;
    }

    .key-btn:active { background: #e5e5e5; }
    .key-btn.bg-gray { background: rgba(255,255,255,0.6); }
    .key-btn.del { color: #ff3b30; font-size: 1.1rem; }

    .status-text {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-align: right;
      margin-top: -5px;
      height: 15px;
    }

    /* ====== Pricing History (right) ====== */
    .history-card{
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.75);
      border-radius: 18px;
      padding: 14px 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      margin-top: 10px;
    }

    .history-head{
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .history-title{
      font-size: 0.85rem;
      font-weight: 950;
      color: #222;
      letter-spacing: -0.2px;
    }

    .history-sub{
      font-size: 0.70rem;
      color: var(--text-secondary);
      margin-top: 3px;
      line-height: 1.25;
    }

    .history-actions{
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .mini-btn{
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.75);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.72rem;
      font-weight: 800;
      cursor: pointer;
      color: #111;
      transition: transform 0.12s, background 0.12s;
      user-select: none;
      white-space: nowrap;
    }
    .mini-btn:active{ transform: scale(0.97); }
    .mini-btn.primary{
      border-color: rgba(0,113,227,0.22);
      background: rgba(0,113,227,0.10);
      color: #0a3d91;
    }
    .mini-btn.danger{
      border-color: rgba(255,59,48,0.22);
      background: rgba(255,59,48,0.10);
      color: #b00020;
    }

    .history-list{
      display: grid;
      gap: 8px;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    details.history-item{
      background: rgba(255,255,255,0.62);
      border: 1px solid rgba(0,0,0,0.04);
      border-radius: 14px;
      padding: 10px 12px;
    }

    details.history-item summary{
      cursor: pointer;
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 0.78rem;
      font-weight: 900;
      color: #111;
    }
    details.history-item summary::-webkit-details-marker{ display:none; }

    .history-meta{
      font-size: 0.70rem;
      color: var(--text-secondary);
      font-weight: 750;
      white-space: nowrap;
    }

    .history-detail{
      margin-top: 10px;
      font-size: 0.73rem;
      color: #333;
      line-height: 1.35;
    }

    .history-detail .row{
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 4px 0;
      border-top: 1px dashed rgba(0,0,0,0.08);
    }
    .history-detail .row:first-child{ border-top: none; }
    .history-detail .k{ color: var(--text-secondary); font-weight: 800; }
    .history-detail .v{ font-weight: 900; color:#111; }

    /* ====== Math / fraction ====== */
    .math{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .frac{
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      line-height: 1.15;
      padding: 2px 6px;
      border-radius: 10px;
      background: rgba(255,255,255,0.45);
      border: 1px solid rgba(0,0,0,0.04);
    }
    .frac .top{
      padding: 0 4px 4px 4px;
      font-size: 0.82rem;
      color: #111;
      white-space: nowrap;
    }
    .frac .bar{
      width: 100%;
      height: 1px;
      background: rgba(0,0,0,0.35);
      margin: 0;
    }
    .frac .bottom{
      padding: 4px 4px 0 4px;
      font-size: 0.82rem;
      color: #111;
      white-space: nowrap;
    }

    /* ====== 左侧小计算器（改：表达式字号更大 + 卡片高度自适应等高） ====== */
    .mini-calc-card{
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mini-calc-head{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .mini-calc-title{
      font-size: 0.9rem;
      font-weight: 950;
      color: #222;
      letter-spacing: -0.2px;
    }

    .mini-calc-display{
      background: rgba(255,255,255,0.72);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 18px;
      padding: 12px 12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.65);
    }

    /* 这里是你要的：输入表达式字体变大 */
    .mini-calc-expr{
      font-size: 1.02rem; /* 原来 0.78rem，明显太小 */
      color: rgba(29,29,31,0.70);
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 18px;
    }

    .mini-calc-value{
      margin-top: 8px;
      font-size: 1.65rem;
      font-weight: 950;
      letter-spacing: -0.8px;
      color: #111;
      text-align: right;
    }

    /* 让按键区在桌面端尽量撑开，配合等高 */
    .mini-calc-pad{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      flex: 1 1 auto;          /* 关键：可伸缩占据高度 */
      align-content: start;    /* 避免拉伸到过大间距 */
    }

    .calc-btn{
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 14px;
      height: 54px;
      font-size: 1.1rem;
      font-weight: 800;
      cursor: pointer;
      color: #111;
      box-shadow: 0 1px 0 rgba(0,0,0,0.12);
      transition: transform 0.12s, background 0.12s;
      user-select: none;
    }
    .calc-btn:active{ transform: scale(0.97); background: rgba(235,235,235,0.95); }
    .calc-btn.op{
      background: rgba(0,113,227,0.10);
      border-color: rgba(0,113,227,0.18);
      color: #0a3d91;
    }
    .calc-btn.warn{
      background: rgba(255,159,10,0.12);
      border-color: rgba(255,159,10,0.20);
      color: #6b4a00;
    }
    .calc-btn.danger{
      background: rgba(255,59,48,0.10);
      border-color: rgba(255,59,48,0.18);
      color: #b00020;
    }
    .calc-btn.equal{
      background: rgba(52,199,89,0.12);
      border-color: rgba(52,199,89,0.20);
      color: #1f6d3b;
    }
    .calc-btn.wide{ grid-column: span 2; }

    .mini-calc-history{
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.04);
      border-radius: 16px;
      padding: 10px 10px;
    }

    .mini-calc-history-title{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .mini-calc-history-title b{
      font-size: 0.78rem;
      font-weight: 950;
      color: #222;
    }
    .mini-calc-history-title span{
      font-size: 0.70rem;
      color: var(--text-secondary);
      font-weight: 800;
    }

    .mini-calc-history-list{
      display:grid;
      gap: 6px;
      max-height: 160px;
      overflow: auto;
    }
    @media (min-width: 980px) {
      .mini-calc-history-list{ max-height: 180px; }
    }

    .calc-h-item{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      background: rgba(255,255,255,0.70);
      border: 1px solid rgba(0,0,0,0.04);
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
    }
    .calc-h-expr{
      font-size: 0.76rem;
      color: #111;
      font-weight: 900;
      max-width: 70%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .calc-h-res{
      font-size: 0.76rem;
      color: #1f6d3b;
      font-weight: 950;
      white-space: nowrap;
    }

    /* ====== 全宽模块（公式 & 天气统一风格） ====== */
    .fullwidth-section{
      margin-top: 22px;
      padding-top: 18px;
      border-top: 1px solid var(--divider);
    }

    .fullwidth-card{
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.75);
      border-radius: 20px;
      padding: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      backdrop-filter: blur(22px) saturate(180%);
      -webkit-backdrop-filter: blur(22px) saturate(180%);
    }

    .fullwidth-head{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .fullwidth-title{
      font-size: 0.9rem;
      font-weight: 900;
      color: #222;
      letter-spacing: -0.2px;
    }

    /* 公式模块内部 */
    .formula-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 980px) {
      .formula-grid{
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
    }
    .formula-pane{
      background: rgba(255,255,255,0.60);
      border: 1px solid rgba(0,0,0,0.04);
      border-radius: 18px;
      padding: 14px;
    }
    .formula-pane-title{
      font-size: 0.82rem;
      font-weight: 950;
      color: #222;
      margin-bottom: 10px;
    }

    .eq-row{
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0;
    }

    .eq-label{
      font-size: 0.8rem;
      font-weight: 800;
      color: #222;
    }

    .eq-equals{
      font-size: 0.95rem;
      font-weight: 800;
      color: #444;
      margin: 0 4px;
    }

    .eq-result{
      font-size: 0.9rem;
      font-weight: 900;
      color: #111;
    }

    .subnote{
      font-size: 0.72rem;
      color: #666;
      margin-top: 2px;
      line-height: 1.35;
    }

    /* ====== Weather module ====== */
    .weather-grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 980px) {
      .weather-grid{
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
    }

    .weather-status{
      font-size: 0.72rem;
      color: var(--text-secondary);
      text-align: right;
    }

    .city-weather-card{
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(255,255,255,0.85);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    }

    .city-head{
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .city-name{
      font-size: 0.85rem;
      font-weight: 900;
      color: #111;
      letter-spacing: -0.2px;
    }

    .city-update{
      font-size: 0.72rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .city-badge{
      font-size: 0.72rem;
      font-weight: 800;
      color: #0a3d91;
      background: rgba(0,113,227,0.10);
      border: 1px solid rgba(0,113,227,0.18);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .city-hero{
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }

    .wx-icon{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.7);
    }

    .city-temp{
      font-size: 1.45rem;
      font-weight: 950;
      letter-spacing: -0.8px;
      color: #111;
      line-height: 1.0;
    }
    .city-temp .deg{
      font-size: 0.95rem;
      font-weight: 850;
      color: #333;
      margin-left: 2px;
    }

    .city-desc{
      font-size: 0.82rem;
      color: #333;
      font-weight: 850;
      margin-top: 2px;
    }

    .city-hilo{
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 2px;
      white-space: nowrap;
    }

    .city-metrics{
      display: grid;
      gap: 8px;
      justify-items: end;
    }

    .metric{
      display: flex;
      gap: 8px;
      align-items: baseline;
      white-space: nowrap;
    }

    .metric-label{
      font-size: 0.72rem;
      color: var(--text-secondary);
      font-weight: 800;
    }

    .metric-val{
      font-size: 0.78rem;
      color: #111;
      font-weight: 900;
    }

    .forecast-strip{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .day-card{
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.04);
      border-radius: 14px;
      padding: 10px 10px;
      text-align: center;
    }

    .day-label{
      font-size: 0.72rem;
      font-weight: 900;
      color: #222;
      margin-bottom: 6px;
      white-space: nowrap;
    }

    .day-icon{
      font-size: 1.05rem;
      margin-bottom: 6px;
    }

    .day-temp{
      font-size: 0.75rem;
      color: #111;
      font-weight: 900;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="calculator-card">
    <h2>Pricing Calc</h2>

    <div class="calc-layout-grid">

      <!-- 左侧：小计算器（等高） -->
      <div class="panel-card mini-calc-card">
        <div class="mini-calc-head">
          <div class="mini-calc-title">小计算器</div>
          <div class="history-actions">
            <button class="mini-btn danger" onclick="clearCalcHistory()">清空历史</button>
          </div>
        </div>

        <div class="mini-calc-display">
          <div class="mini-calc-expr math" id="calcExpr"> </div>
          <div class="mini-calc-value math" id="calcValue">0</div>
        </div>

        <div class="mini-calc-pad">
          <button class="calc-btn danger" onclick="calcPress('AC')">AC</button>
          <button class="calc-btn warn" onclick="calcPress('DEL')">⌫</button>
          <button class="calc-btn warn" onclick="calcPress('%')">%</button>
          <button class="calc-btn op" onclick="calcPress('/')">÷</button>

          <button class="calc-btn" onclick="calcPress('7')">7</button>
          <button class="calc-btn" onclick="calcPress('8')">8</button>
          <button class="calc-btn" onclick="calcPress('9')">9</button>
          <button class="calc-btn op" onclick="calcPress('*')">×</button>

          <button class="calc-btn" onclick="calcPress('4')">4</button>
          <button class="calc-btn" onclick="calcPress('5')">5</button>
          <button class="calc-btn" onclick="calcPress('6')">6</button>
          <button class="calc-btn op" onclick="calcPress('-')">−</button>

          <button class="calc-btn" onclick="calcPress('1')">1</button>
          <button class="calc-btn" onclick="calcPress('2')">2</button>
          <button class="calc-btn" onclick="calcPress('3')">3</button>
          <button class="calc-btn op" onclick="calcPress('+')">+</button>

          <button class="calc-btn warn" onclick="calcPress('(')">(</button>
          <button class="calc-btn warn" onclick="calcPress(')')">)</button>
          <button class="calc-btn" onclick="calcPress('0')">0</button>
          <button class="calc-btn" onclick="calcPress('.')">.</button>

          <button class="calc-btn equal wide" onclick="calcPress('=')">=</button>
          <button class="calc-btn warn wide" onclick="calcUseLastResult()">Ans</button>
        </div>

        <div class="mini-calc-history">
          <div class="mini-calc-history-title">
            <b>最近 5 条</b>
            <span>点一下回填</span>
          </div>
          <div class="mini-calc-history-list" id="calcHistoryList"></div>
        </div>
      </div>

      <!-- 中间：成本输入（等高） -->
      <div class="panel-card">
        <div class="input-group">
          <div class="label-row">
            <label>原始成本</label>
            <div class="segmented-control">
              <button class="segment-btn active" id="btn-cny" onclick="setCostCurrency('CNY')">¥ CNY</button>
              <button class="segment-btn" id="btn-usd" onclick="setCostCurrency('USD')">$ USD</button>
            </div>
          </div>

          <div class="input-wrapper" id="wrap-inputValue">
            <input type="number" id="inputValue" placeholder="0.00" oninput="calculateDebounced()" onfocus="focusInput('inputValue')">
            <span class="unit-label" id="costUnitLabel">CNY</span>
          </div>
        </div>

        <div class="input-group">
          <label>目标利润率 (%)</label>
          <div class="input-wrapper" id="wrap-marginValue">
            <input type="number" id="marginValue" value="40" oninput="calculateDebounced()" onfocus="focusInput('marginValue')">
            <span class="unit-label">%</span>
          </div>
          <div class="preset-group">
            <button class="preset-btn" onclick="setPreset('marginValue', 10)">10%</button>
            <button class="preset-btn" onclick="setPreset('marginValue', 20)">20%</button>
            <button class="preset-btn" onclick="setPreset('marginValue', 30)">30%</button>
            <button class="preset-btn" onclick="setPreset('marginValue', 40)">40%</button>
            <button class="preset-btn" onclick="setPreset('marginValue', 50)">50%</button>
          </div>
        </div>

        <div class="input-group">
          <label>固定运费/杂费 (CNY)</label>
          <div class="input-wrapper" id="wrap-shippingCost">
            <input type="number" id="shippingCost" value="0.5" step="0.1" oninput="calculateDebounced()" onfocus="focusInput('shippingCost')">
            <span class="unit-label">¥</span>
          </div>
          <div class="preset-group">
            <button class="preset-btn" onclick="setPreset('shippingCost', 0)">0</button>
            <button class="preset-btn" onclick="setPreset('shippingCost', 0.1)">0.1</button>
            <button class="preset-btn" onclick="setPreset('shippingCost', 0.2)">0.2</button>
            <button class="preset-btn" onclick="setPreset('shippingCost', 0.3)">0.3</button>
            <button class="preset-btn" onclick="setPreset('shippingCost', 0.4)">0.4</button>
            <button class="preset-btn" onclick="setPreset('shippingCost', 0.5)">0.5</button>
          </div>
        </div>

        <div class="input-group">
          <label style="display:flex; justify-content:space-between;">
            汇率 (CNY/USD)
            <span class="status-text" id="apiStatus">初始化...</span>
          </label>
          <div class="input-wrapper" id="wrap-exchangeRate">
            <input type="number" id="exchangeRate" value="7.25" step="0.001" oninput="manualRateLock(); calculateDebounced()" onfocus="focusInput('exchangeRate')">
          </div>
        </div>

        <div class="input-group" style="margin-top:-6px;">
          <label>汇率安全垫 (%)</label>
          <div class="input-wrapper" id="wrap-rateBuffer">
            <input type="number" id="rateBuffer" value="1.5" step="0.1" oninput="calculateDebounced()" onfocus="focusInput('rateBuffer')">
            <span class="unit-label">%</span>
          </div>
          <div class="preset-group">
            <button class="preset-btn" onclick="setPreset('rateBuffer', 0)">0%</button>
            <button class="preset-btn" onclick="setPreset('rateBuffer', 1)">1%</button>
            <button class="preset-btn" onclick="setPreset('rateBuffer', 1.5)">1.5%</button>
            <button class="preset-btn" onclick="setPreset('rateBuffer', 2)">2%</button>
            <button class="preset-btn" onclick="setPreset('rateBuffer', 3)">3%</button>
          </div>
        </div>

        <div class="input-group" style="margin-top:-6px;">
          <label>平台手续费 (%)</label>
          <div class="input-wrapper" id="wrap-platformFee">
            <input type="number" id="platformFee" value="0.3" step="0.1" oninput="calculateDebounced()" onfocus="focusInput('platformFee')">
            <span class="unit-label">%</span>
          </div>
          <div class="preset-group">
            <button class="preset-btn" onclick="setPreset('platformFee', 0)">0%</button>
            <button class="preset-btn" onclick="setPreset('platformFee', 0.3)">0.3%</button>
            <button class="preset-btn" onclick="setPreset('platformFee', 0.5)">0.5%</button>
            <button class="preset-btn" onclick="setPreset('platformFee', 1)">1%</button>
            <button class="preset-btn" onclick="setPreset('platformFee', 2)">2%</button>
          </div>
        </div>
      </div>

      <div class="divider-mobile"></div>

      <!-- 右侧：结果 + 历史（等高） -->
      <div class="panel-card">
        <div class="results-container">
          <div class="result-box">
            <span class="res-label">人民币 (CNY)</span>
            <span class="res-value cny-val" id="resCNY">¥0.0000</span>
          </div>
          <div class="result-box">
            <span class="res-label">美元 (USD)</span>
            <span class="res-value usd-val" id="resUSD">$0.0000</span>
          </div>
        </div>

        <div class="history-card">
          <div class="history-head">
            <div>
              <div class="history-title">成本计算历史（最近 5 条）</div>
              <div class="history-sub">
                自动保存：停止输入 <span class="math">0.7s</span> 后保存（结果有效时）<br/>
                也可点「保存本次」手动记录
              </div>
            </div>
            <div class="history-actions">
              <button class="mini-btn primary" onclick="savePricingHistory(true)">保存本次</button>
              <button class="mini-btn danger" onclick="clearPricingHistory()">清空</button>
            </div>
          </div>
          <ul class="history-list" id="pricingHistoryList"></ul>
        </div>

        <div class="virtual-keypad">
          <button class="key-btn" onclick="pressKey('1')">1</button>
          <button class="key-btn" onclick="pressKey('2')">2</button>
          <button class="key-btn" onclick="pressKey('3')">3</button>
          <button class="key-btn" onclick="pressKey('4')">4</button>
          <button class="key-btn" onclick="pressKey('5')">5</button>
          <button class="key-btn" onclick="pressKey('6')">6</button>
          <button class="key-btn" onclick="pressKey('7')">7</button>
          <button class="key-btn" onclick="pressKey('8')">8</button>
          <button class="key-btn" onclick="pressKey('9')">9</button>
          <button class="key-btn bg-gray" onclick="pressKey('.')">.</button>
          <button class="key-btn" onclick="pressKey('0')">0</button>
          <button class="key-btn bg-gray del" onclick="pressDel()">⌫</button>
        </div>
      </div>
    </div>

    <!-- ✅ 全宽：当前计算公式（从右侧移到这里） -->
    <div class="fullwidth-section">
      <div class="fullwidth-card">
        <div class="fullwidth-head">
          <div class="fullwidth-title">当前计算公式（分式展示）</div>
        </div>

        <div class="formula-grid">
          <div class="formula-pane">
            <div class="formula-pane-title">人民币售价 (CNY)</div>

            <div class="eq-row">
              <span class="eq-label">人民币售价</span>
              <span class="eq-equals">=</span>
              <span class="frac math">
                <span class="top">总成本（人民币）</span>
                <span class="bar"></span>
                <span class="bottom">(1 − 目标利润率) × (1 − 平台手续费率)</span>
              </span>
              <span class="eq-equals">=</span>
              <span class="eq-result math" id="cnyResultText">—</span>
            </div>
            <div class="subnote math" id="cnySubText">—</div>
          </div>

          <div class="formula-pane">
            <div class="formula-pane-title">美元售价 (USD)</div>

            <div class="eq-row">
              <span class="eq-label">美元售价</span>
              <span class="eq-equals">=</span>
              <span class="frac math">
                <span class="top">人民币售价</span>
                <span class="bar"></span>
                <span class="bottom">汇率（CNY/USD） × (1 − 汇率安全垫)</span>
              </span>
              <span class="eq-equals">=</span>
              <span class="eq-result math" id="usdResultText">—</span>
            </div>
            <div class="subnote math" id="usdSubText">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 天气模块（保持全宽） -->
    <div class="fullwidth-section">
      <div class="fullwidth-card">
        <div class="fullwidth-head">
          <div class="fullwidth-title">天气预报（今日 + 未来三天）</div>
          <div class="weather-status" id="weatherStatus">初始化...</div>
        </div>

        <div class="weather-grid">
          <!-- 道真 -->
          <div class="city-weather-card" id="city-dz">
            <div class="city-head">
              <div>
                <div class="city-name" id="dz_name">贵州·遵义·道真县</div>
                <div class="city-update" id="dz_update">更新时间：--:--</div>
              </div>
              <div class="city-badge" id="dz_badge">今日</div>
            </div>

            <div class="city-hero">
              <div class="wx-icon" id="dz_icon">⛅</div>
              <div>
                <div class="city-temp"><span id="dz_temp">--</span><span class="deg">°C</span></div>
                <div class="city-desc" id="dz_text">--</div>
                <div class="city-hilo" id="dz_hilo">最高/最低：-- / -- °C</div>
              </div>
              <div class="city-metrics">
                <div class="metric"><span class="metric-label">湿度</span><span class="metric-val" id="dz_hum">--%</span></div>
                <div class="metric"><span class="metric-label">风速</span><span class="metric-val" id="dz_wind">-- m/s</span></div>
              </div>
            </div>

            <div class="forecast-strip">
              <div class="day-card">
                <div class="day-label" id="dz_d1_label">明天</div>
                <div class="day-icon" id="dz_d1_icon">—</div>
                <div class="day-temp" id="dz_d1_temp">-- / -- °C</div>
              </div>
              <div class="day-card">
                <div class="day-label" id="dz_d2_label">后天</div>
                <div class="day-icon" id="dz_d2_icon">—</div>
                <div class="day-temp" id="dz_d2_temp">-- / -- °C</div>
              </div>
              <div class="day-card">
                <div class="day-label" id="dz_d3_label">大后天</div>
                <div class="day-icon" id="dz_d3_icon">—</div>
                <div class="day-temp" id="dz_d3_temp">-- / -- °C</div>
              </div>
            </div>
          </div>

          <!-- 南岗 -->
          <div class="city-weather-card" id="city-ng">
            <div class="city-head">
              <div>
                <div class="city-name" id="ng_name">黑龙江·哈尔滨·南岗区</div>
                <div class="city-update" id="ng_update">更新时间：--:--</div>
              </div>
              <div class="city-badge" id="ng_badge">今日</div>
            </div>

            <div class="city-hero">
              <div class="wx-icon" id="ng_icon">⛅</div>
              <div>
                <div class="city-temp"><span id="ng_temp">--</span><span class="deg">°C</span></div>
                <div class="city-desc" id="ng_text">--</div>
                <div class="city-hilo" id="ng_hilo">最高/最低：-- / -- °C</div>
              </div>
              <div class="city-metrics">
                <div class="metric"><span class="metric-label">湿度</span><span class="metric-val" id="ng_hum">--%</span></div>
                <div class="metric"><span class="metric-label">风速</span><span class="metric-val" id="ng_wind">-- m/s</span></div>
              </div>
            </div>

            <div class="forecast-strip">
              <div class="day-card">
                <div class="day-label" id="ng_d1_label">明天</div>
                <div class="day-icon" id="ng_d1_icon">—</div>
                <div class="day-temp" id="ng_d1_temp">-- / -- °C</div>
              </div>
              <div class="day-card">
                <div class="day-label" id="ng_d2_label">后天</div>
                <div class="day-icon" id="ng_d2_icon">—</div>
                <div class="day-temp" id="ng_d2_temp">-- / -- °C</div>
              </div>
              <div class="day-card">
                <div class="day-label" id="ng_d3_label">大后天</div>
                <div class="day-icon" id="ng_d3_icon">—</div>
                <div class="day-temp" id="ng_d3_temp">-- / -- °C</div>
              </div>
            </div>
          </div>
        </div>

        <div class="weather-status" style="margin-top:10px;">
          提示：这是前端直连 API 的实现方式；如果页面对外公开，建议用 Worker/后端代理隐藏 Key。
        </div>
      </div>
    </div>

  </div>

  <script>
    // =========================
    // Exchange rate API (existing)
    // =========================
    const API_KEY = '598fef75b65d4c4074c91fe0';
    const STORAGE_KEY = 'rate_limiter_v1';

    // =========================
    // QWeather (HeFeng) config
    // =========================
    const QW_API_KEY = '758f01261e644865a765152b67e087cf';
    const QW_API_HOST = 'ku62b6xbgd.re.qweatherapi.com';

    const WEATHER_CACHE_KEY = 'weather_cache_v1';
    const WEATHER_LIMIT_KEY = 'weather_limiter_v1';
    const WEATHER_MAX_CALLS_PER_DAY = 20;
    const WEATHER_MIN_REFRESH_MINUTES = 30;

    const WEATHER_PLACES = [
      { id: 'dz', displayName: '贵州·遵义·道真县', location: '道真', adm: '遵义', range: 'cn' },
      { id: 'ng', displayName: '黑龙江·哈尔滨·南岗区', location: '南岗', adm: '哈尔滨', range: 'cn' }
    ];

    // =========================
    // Pricing history config
    // =========================
    const PRICING_HISTORY_KEY = 'pricing_history_v1';
    const PRICING_HISTORY_MAX = 5;
    const PRICING_AUTOSAVE_DEBOUNCE_MS = 700;

    // =========================
    // Mini calculator history config
    // =========================
    const CALC_HISTORY_KEY = 'mini_calc_history_v1';
    const CALC_HISTORY_MAX = 5;

    let activeInputId = 'inputValue';
    let costCurrency = 'CNY';

    // For debounced autosave
    let autosaveTimer = null;
    let lastSnapshotKey = "";

    // Mini calculator state
    let calcExpression = "";
    let calcLastResult = 0;

    window.onload = function() {
      checkAndFetchRate();
      focusInput('inputValue');
      initWeather();

      renderPricingHistory();
      renderCalcHistory();
      updateCalcDisplay();
    };

    // =========================
    // Exchange Rate
    // =========================
    function checkAndFetchRate() {
      const statusEl = document.getElementById('apiStatus');
      const todayStr = new Date().toDateString();
      let store = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { date: '', count: 0, rate: 7.25 };

      if (store.date !== todayStr) {
        store.date = todayStr;
        store.count = 0;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
      }

      if (store.count < 5) {
        statusEl.innerText = "正在更新汇率...";
        fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/latest/USD`)
          .then(res => res.json())
          .then(data => {
            if (data.conversion_rates && data.conversion_rates.CNY) {
              const newRate = data.conversion_rates.CNY;
              document.getElementById('exchangeRate').value = newRate;
              calculateDebounced();
              store.count += 1;
              store.rate = newRate;
              localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
              statusEl.innerText = `已更新 (今日第${store.count}次)`;
              statusEl.style.color = "#34c759";
            } else {
              throw new Error("No CNY rate in response");
            }
          })
          .catch(err => {
            console.error(err);
            document.getElementById('exchangeRate').value = store.rate;
            statusEl.innerText = "更新失败，使用缓存";
            statusEl.style.color = "#ff3b30";
            calculateDebounced();
          });
      } else {
        document.getElementById('exchangeRate').value = store.rate;
        calculateDebounced();
        statusEl.innerText = "已达今日上限 (5次)";
        statusEl.style.color = "#86868b";
      }
    }

    function manualRateLock() {
      const statusEl = document.getElementById('apiStatus');
      statusEl.innerText = "手动输入";
      statusEl.style.color = "#ff9f0a";
    }

    // =========================
    // UI helpers (cost inputs)
    // =========================
    function setCostCurrency(currency) {
      costCurrency = currency;
      document.getElementById('btn-cny').classList.remove('active');
      document.getElementById('btn-usd').classList.remove('active');
      document.getElementById('btn-' + currency.toLowerCase()).classList.add('active');
      document.getElementById('costUnitLabel').innerText = currency;
      calculateDebounced();
    }

    function focusInput(id) {
      activeInputId = id;
      document.querySelectorAll('.input-wrapper').forEach(el => el.classList.remove('active-wrapper'));
      const wrapper = document.getElementById('wrap-' + id);
      if(wrapper) wrapper.classList.add('active-wrapper');
    }

    function setPreset(id, val) {
      document.getElementById(id).value = val;
      focusInput(id);
      calculateDebounced();
    }

    function pressKey(key) {
      const el = document.getElementById(activeInputId);
      if (!el) return;
      if (el.value === '0' && key !== '.') el.value = key;
      else {
        if (key === '.' && el.value.includes('.')) return;
        el.value += key;
      }
      calculateDebounced();
    }

    function pressDel() {
      const el = document.getElementById(activeInputId);
      if (!el) return;
      el.value = el.value.slice(0, -1);
      calculateDebounced();
    }

    function fmt4(x) {
      if (!isFinite(x)) return "NaN";
      return Number(x).toFixed(4);
    }

    function fmtCNY(x) {
      if (!isFinite(x)) return "¥0.0000";
      return "¥" + Number(x).toLocaleString('zh-CN', {minimumFractionDigits: 4, maximumFractionDigits: 4});
    }

    function fmtUSD(x) {
      if (!isFinite(x)) return "$0.0000";
      return "$" + Number(x).toLocaleString('en-US', {minimumFractionDigits: 4, maximumFractionDigits: 4});
    }

    // =========================
    // Calculate + debounced autosave
    // =========================
    function calculateDebounced() {
      calculate();
      if (autosaveTimer) clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => {
        savePricingHistory(false);
      }, PRICING_AUTOSAVE_DEBOUNCE_MS);
    }

    function getPricingSnapshot() {
      const rawInputValue = parseFloat(document.getElementById('inputValue').value);
      const targetProfitMarginPercent = parseFloat(document.getElementById('marginValue').value) || 40;
      const fixedShippingAndMiscCostCNY = parseFloat(document.getElementById('shippingCost').value);
      const exchangeRateCNYPerUSD = parseFloat(document.getElementById('exchangeRate').value);

      const exchangeRateSafetyBufferPercent = parseFloat(document.getElementById('rateBuffer').value) || 0;
      const platformFeePercent = parseFloat(document.getElementById('platformFee').value) || 0;

      if (!isFinite(rawInputValue)) return { valid: false };

      const finalFixedShippingAndMiscCostCNY = isFinite(fixedShippingAndMiscCostCNY) ? fixedShippingAndMiscCostCNY : 0.5;

      let totalCostCNY = 0;
      if (costCurrency === 'USD') {
        if (isFinite(exchangeRateCNYPerUSD) && exchangeRateCNYPerUSD !== 0) {
          totalCostCNY = (rawInputValue * exchangeRateCNYPerUSD) + finalFixedShippingAndMiscCostCNY;
        } else {
          return { valid: false };
        }
      } else {
        totalCostCNY = rawInputValue + finalFixedShippingAndMiscCostCNY;
      }

      const targetProfitMarginRate = targetProfitMarginPercent / 100;
      const platformFeeRate = platformFeePercent / 100;
      const exchangeRateSafetyBufferRate = exchangeRateSafetyBufferPercent / 100;

      const cnyDivisor = (1 - targetProfitMarginRate) * (1 - platformFeeRate);
      if (!(cnyDivisor > 0)) return { valid: false };

      const pricingResultCNY = totalCostCNY / cnyDivisor;

      const effectiveExchangeRateCNYPerUSD = exchangeRateCNYPerUSD * (1 - exchangeRateSafetyBufferRate);
      if (!(isFinite(effectiveExchangeRateCNYPerUSD) && effectiveExchangeRateCNYPerUSD > 0)) return { valid: false };

      const pricingResultUSD = pricingResultCNY / effectiveExchangeRateCNYPerUSD;

      return {
        valid: isFinite(pricingResultCNY) && isFinite(pricingResultUSD),
        timestamp: Date.now(),
        inputCurrency: costCurrency,
        inputValue: rawInputValue,

        targetProfitMarginPercent,
        fixedShippingAndMiscCostCNY: finalFixedShippingAndMiscCostCNY,
        exchangeRateCNYPerUSD,
        exchangeRateSafetyBufferPercent,
        platformFeePercent,

        totalCostCNY,
        pricingResultCNY,
        pricingResultUSD
      };
    }

    function calculate() {
      const snap = getPricingSnapshot();

      if (!snap.valid) {
        document.getElementById('resCNY').innerText = "¥0.0000";
        document.getElementById('resUSD').innerText = "$0.0000";
        document.getElementById('cnyResultText').innerText = "—";
        document.getElementById('usdResultText').innerText = "—";
        document.getElementById('cnySubText').innerText = "—";
        document.getElementById('usdSubText').innerText = "—";
        return;
      }

      document.getElementById('resCNY').innerText = fmtCNY(snap.pricingResultCNY);
      document.getElementById('resUSD').innerText = fmtUSD(snap.pricingResultUSD);

      document.getElementById('cnyResultText').innerText = `${fmt4(snap.pricingResultCNY)} CNY`;
      document.getElementById('usdResultText').innerText = `${fmt4(snap.pricingResultUSD)} USD`;

      const targetProfitMarginRate = snap.targetProfitMarginPercent / 100;
      const platformFeeRate = snap.platformFeePercent / 100;
      const exchangeRateSafetyBufferRate = snap.exchangeRateSafetyBufferPercent / 100;

      document.getElementById('cnySubText').innerText =
        `代入：人民币售价 = ${fmt4(snap.totalCostCNY)} ÷ ((1 − ${fmt4(targetProfitMarginRate)}) × (1 − ${fmt4(platformFeeRate)}))`;

      document.getElementById('usdSubText').innerText =
        `代入：美元售价 = ${fmt4(snap.pricingResultCNY)} ÷ (${fmt4(snap.exchangeRateCNYPerUSD)} × (1 − ${fmt4(exchangeRateSafetyBufferRate)}))`;
    }

    // =========================
    // Pricing history
    // =========================
    function loadPricingHistory() {
      return JSON.parse(localStorage.getItem(PRICING_HISTORY_KEY)) || [];
    }

    function savePricingHistoryStore(arr) {
      localStorage.setItem(PRICING_HISTORY_KEY, JSON.stringify(arr));
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function formatInputOriginal(entry) {
      const v = isFinite(entry.inputValue) ? entry.inputValue : 0;
      const val = Number(v).toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      return `${val} ${entry.inputCurrency}`;
    }

    function snapshotKeyForDedupe(snap) {
      return [
        snap.inputCurrency,
        Number(snap.inputValue).toFixed(6),
        Number(snap.targetProfitMarginPercent).toFixed(3),
        Number(snap.fixedShippingAndMiscCostCNY).toFixed(6),
        Number(snap.exchangeRateCNYPerUSD).toFixed(6),
        Number(snap.exchangeRateSafetyBufferPercent).toFixed(3),
        Number(snap.platformFeePercent).toFixed(3),
        Number(snap.pricingResultUSD).toFixed(6)
      ].join("|");
    }

    function savePricingHistory(isManual) {
      const snap = getPricingSnapshot();
      if (!snap.valid) return;

      const key = snapshotKeyForDedupe(snap);
      if (!isManual) {
        if (key === lastSnapshotKey) return;
      }

      const history = loadPricingHistory();
      if (history.length > 0) {
        const topKey = snapshotKeyForDedupe(history[0]);
        if (topKey === key) {
          lastSnapshotKey = key;
          return;
        }
      }

      history.unshift(snap);
      savePricingHistoryStore(history.slice(0, PRICING_HISTORY_MAX));

      lastSnapshotKey = key;
      renderPricingHistory();
    }

    function clearPricingHistory() {
      localStorage.removeItem(PRICING_HISTORY_KEY);
      renderPricingHistory();
    }

    function renderPricingHistory() {
      const listEl = document.getElementById('pricingHistoryList');
      const history = loadPricingHistory();

      listEl.innerHTML = "";
      if (!history.length) {
        const empty = document.createElement('div');
        empty.style.fontSize = "0.74rem";
        empty.style.color = "var(--text-secondary)";
        empty.style.fontWeight = "800";
        empty.style.padding = "8px 2px";
        empty.innerText = "暂无记录（计算一次后会自动保存）";
        listEl.appendChild(empty);
        return;
      }

      for (const entry of history) {
        const li = document.createElement('li');

        const det = document.createElement('details');
        det.className = 'history-item';

        const sum = document.createElement('summary');

        const left = document.createElement('span');
        left.innerText = `${formatInputOriginal(entry)} → ${fmtUSD(entry.pricingResultUSD)}`;

        const right = document.createElement('span');
        right.className = 'history-meta';
        right.innerText = formatTime(entry.timestamp);

        sum.appendChild(left);
        sum.appendChild(right);

        const detail = document.createElement('div');
        detail.className = 'history-detail';

        const rows = [
          ["原始输入币种", entry.inputCurrency],
          ["原始输入数值", Number(entry.inputValue).toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 6})],
          ["目标利润率 (%)", entry.targetProfitMarginPercent],
          ["固定运费/杂费 (CNY)", entry.fixedShippingAndMiscCostCNY],
          ["汇率 (CNY/USD)", entry.exchangeRateCNYPerUSD],
          ["汇率安全垫 (%)", entry.exchangeRateSafetyBufferPercent],
          ["平台手续费 (%)", entry.platformFeePercent],
          ["总成本（人民币）", fmt4(entry.totalCostCNY)],
          ["人民币售价", fmt4(entry.pricingResultCNY)],
          ["美元售价", fmt4(entry.pricingResultUSD)]
        ];

        for (const [k, v] of rows) {
          const r = document.createElement('div');
          r.className = 'row';

          const kk = document.createElement('div');
          kk.className = 'k';
          kk.innerText = k;

          const vv = document.createElement('div');
          vv.className = 'v';
          vv.innerText = String(v);

          r.appendChild(kk);
          r.appendChild(vv);
          detail.appendChild(r);
        }

        det.appendChild(sum);
        det.appendChild(detail);
        li.appendChild(det);
        listEl.appendChild(li);
      }
    }

    // =========================
    // Mini Calculator
    // =========================
    function updateCalcDisplay() {
      const exprEl = document.getElementById('calcExpr');
      const valEl = document.getElementById('calcValue');
      exprEl.innerText = calcExpression.trim() ? calcExpression : " ";
      valEl.innerText = String(calcLastResult);
    }

    function calcPress(key) {
      if (key === 'AC') {
        calcExpression = "";
        calcLastResult = 0;
        updateCalcDisplay();
        return;
      }

      if (key === 'DEL') {
        calcExpression = calcExpression.slice(0, -1);
        updateCalcDisplay();
        return;
      }

      if (key === '=') {
        const result = safeEvalExpression(calcExpression);
        if (result.ok) {
          calcLastResult = normalizeNumber(result.value);
          saveCalcHistory(calcExpression, calcLastResult);
          calcExpression = String(calcLastResult);
        } else {
          calcLastResult = "Error";
        }
        updateCalcDisplay();
        renderCalcHistory();
        return;
      }

      const last = calcExpression.slice(-1);
      const isOp = (ch) => ['+','-','*','/'].includes(ch);
      const isKeyOp = (ch) => ['+','-','*','/'].includes(ch);

      if (isKeyOp(key)) {
        if (calcExpression.trim() === "" && key !== '-') return;
        if (isOp(last)) {
          calcExpression = calcExpression.slice(0, -1) + key;
          updateCalcDisplay();
          return;
        }
      }

      if (key === '.') {
        const tail = calcExpression.split(/[\+\-\*\/\(\)\%]/).pop();
        if (tail.includes('.')) return;
      }

      calcExpression += key;
      updateCalcDisplay();
    }

    function calcUseLastResult() {
      if (calcLastResult === "Error") return;
      calcExpression += String(calcLastResult);
      updateCalcDisplay();
    }

    function normalizeNumber(x) {
      const n = Number(x);
      if (!isFinite(n)) return "Error";
      const s = n.toString();
      if (s.includes('e') || s.length > 14) return Number(n.toPrecision(12));
      return Number((Math.round(n * 1e12) / 1e12).toString());
    }

    function safeEvalExpression(expr) {
      try {
        const tokens = tokenize(expr);
        if (!tokens.length) return { ok: false, error: "Empty" };
        const rpn = toRPN(tokens);
        const val = evalRPN(rpn);
        if (!isFinite(val)) return { ok: false, error: "NaN" };
        return { ok: true, value: val };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    function tokenize(expr) {
      const cleaned = (expr || "").replace(/\s+/g, '');
      const out = [];
      let i = 0;
      const isDigit = (c) => c >= '0' && c <= '9';

      while (i < cleaned.length) {
        const c = cleaned[i];

        if (isDigit(c) || c === '.' || (c === '-' && (i === 0 || ['+','-','*','/','('].includes(cleaned[i-1])))) {
          let j = i;
          let hasDot = false;
          if (cleaned[j] === '-') j++;

          while (j < cleaned.length) {
            const cc = cleaned[j];
            if (isDigit(cc)) { j++; continue; }
            if (cc === '.') {
              if (hasDot) break;
              hasDot = true; j++; continue;
            }
            break;
          }

          const numStr = cleaned.slice(i, j);
          if (numStr === '-' || numStr === '.') throw new Error("Bad number");
          out.push({ type: 'num', value: Number(numStr) });
          i = j;
          continue;
        }

        if (['+','-','*','/','(',')','%'].includes(c)) {
          out.push({ type: 'op', value: c });
          i++;
          continue;
        }

        throw new Error("Invalid char");
      }
      return out;
    }

    function toRPN(tokens) {
      const output = [];
      const ops = [];
      const precedence = (op) => {
        if (op === '%') return 4;
        if (op === '*' || op === '/') return 3;
        if (op === '+' || op === '-') return 2;
        return 0;
      };
      const isLeftAssoc = () => true;

      for (const t of tokens) {
        if (t.type === 'num') { output.push(t); continue; }
        const op = t.value;

        if (op === '(') { ops.push(op); continue; }
        if (op === ')') {
          while (ops.length && ops[ops.length - 1] !== '(') {
            output.push({ type: 'op', value: ops.pop() });
          }
          if (!ops.length) throw new Error("Mismatched )");
          ops.pop();
          continue;
        }

        while (ops.length) {
          const top = ops[ops.length - 1];
          if (top === '(') break;
          const p1 = precedence(op);
          const p2 = precedence(top);
          if ((isLeftAssoc(op) && p1 <= p2)) output.push({ type: 'op', value: ops.pop() });
          else break;
        }
        ops.push(op);
      }

      while (ops.length) {
        const top = ops.pop();
        if (top === '(' || top === ')') throw new Error("Mismatched ()");
        output.push({ type: 'op', value: top });
      }
      return output;
    }

    function evalRPN(rpn) {
      const stack = [];
      for (const t of rpn) {
        if (t.type === 'num') { stack.push(t.value); continue; }
        const op = t.value;

        if (op === '%') {
          if (stack.length < 1) throw new Error("Bad %");
          const a = stack.pop();
          stack.push(a / 100);
          continue;
        }

        if (stack.length < 2) throw new Error("Bad op");
        const b = stack.pop();
        const a = stack.pop();

        if (op === '+') stack.push(a + b);
        else if (op === '-') stack.push(a - b);
        else if (op === '*') stack.push(a * b);
        else if (op === '/') stack.push(a / b);
        else throw new Error("Unknown op");
      }
      if (stack.length !== 1) throw new Error("Bad expr");
      return stack[0];
    }

    // =========================
    // Mini calculator history
    // =========================
    function loadCalcHistory() {
      return JSON.parse(localStorage.getItem(CALC_HISTORY_KEY)) || [];
    }

    function saveCalcHistoryStore(arr) {
      localStorage.setItem(CALC_HISTORY_KEY, JSON.stringify(arr));
    }

    function saveCalcHistory(expr, result) {
      const e = (expr || "").trim();
      if (!e) return;
      if (result === "Error") return;

      const history = loadCalcHistory();
      const entry = { ts: Date.now(), expr: e, res: String(result) };

      if (history.length > 0 && history[0].expr === entry.expr && history[0].res === entry.res) return;

      history.unshift(entry);
      saveCalcHistoryStore(history.slice(0, CALC_HISTORY_MAX));
    }

    function clearCalcHistory() {
      localStorage.removeItem(CALC_HISTORY_KEY);
      renderCalcHistory();
    }

    function renderCalcHistory() {
      const list = document.getElementById('calcHistoryList');
      const history = loadCalcHistory();
      list.innerHTML = "";

      if (!history.length) {
        const empty = document.createElement('div');
        empty.style.fontSize = "0.74rem";
        empty.style.color = "var(--text-secondary)";
        empty.style.fontWeight = "850";
        empty.style.padding = "6px 2px";
        empty.innerText = "暂无记录（按 = 后自动保存）";
        list.appendChild(empty);
        return;
      }

      for (const h of history) {
        const item = document.createElement('div');
        item.className = 'calc-h-item';

        const left = document.createElement('div');
        left.className = 'calc-h-expr math';
        left.innerText = h.expr;

        const right = document.createElement('div');
        right.className = 'calc-h-res math';
        right.innerText = "= " + h.res;

        item.appendChild(left);
        item.appendChild(right);

        item.onclick = () => {
          calcExpression = h.expr;
          const v = Number(h.res);
          calcLastResult = isFinite(v) ? normalizeNumber(v) : h.res;
          updateCalcDisplay();
        };

        list.appendChild(item);
      }
    }

    // =========================
    // Weather module (QWeather)
    // =========================
    function setWeatherStatus(text, color = "#86868b") {
      const el = document.getElementById('weatherStatus');
      el.innerText = text;
      el.style.color = color;
    }

    function setCityBadge(cityId, text, color = "#0a3d91", bg = "rgba(0,113,227,0.10)", bd = "rgba(0,113,227,0.18)") {
      const el = document.getElementById(`${cityId}_badge`);
      if (!el) return;
      el.innerText = text;
      el.style.color = color;
      el.style.background = bg;
      el.style.borderColor = bd;
    }

    function safeNum(v, fallback = null) {
      const n = Number(v);
      return isFinite(n) ? n : fallback;
    }

    function hhmmFromISO(isoString) {
      if (!isoString) return "--:--";
      const t = isoString.split('T')[1] || "";
      if (!t) return "--:--";
      const hh = t.slice(0,2);
      const mm = t.slice(3,5);
      if (hh && mm) return `${hh}:${mm}`;
      return "--:--";
    }

    function iconEmojiFromQWCode(codeStr) {
      const c = parseInt(codeStr, 10);
      if (!isFinite(c)) return "⛅";
      if (c === 100) return "☀️";
      if (c >= 101 && c <= 103) return "⛅";
      if (c === 104) return "☁️";
      if (c >= 300 && c <= 399) return "🌧️";
      if (c >= 200 && c <= 213) return "⛈️";
      if (c >= 400 && c <= 499) return "❄️";
      if (c >= 500 && c <= 599) return "🌫️";
      if (c >= 600 && c <= 699) return "🌪️";
      if (c >= 700 && c <= 799) return "🌫️";
      if (c >= 800) return "🌙";
      return "⛅";
    }

    function setCityPlaceholder(cityId) {
      document.getElementById(`${cityId}_update`).innerText = "更新时间：--:--";
      document.getElementById(`${cityId}_icon`).innerText = "—";
      document.getElementById(`${cityId}_temp`).innerText = "--";
      document.getElementById(`${cityId}_text`).innerText = "--";
      document.getElementById(`${cityId}_hilo`).innerText = "最高/最低：-- / -- °C";
      document.getElementById(`${cityId}_hum`).innerText = "--%";
      document.getElementById(`${cityId}_wind`).innerText = "-- m/s";
      for (let i = 1; i <= 3; i++) {
        document.getElementById(`${cityId}_d${i}_icon`).innerText = "—";
        document.getElementById(`${cityId}_d${i}_temp`).innerText = "-- / -- °C";
      }
    }

    function loadWeatherStore() {
      return JSON.parse(localStorage.getItem(WEATHER_CACHE_KEY)) || {
        lastFetchTs: 0,
        cache: {},
        geo: {}
      };
    }

    function saveWeatherStore(store) {
      localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify(store));
    }

    function loadWeatherLimiter() {
      const todayStr = new Date().toDateString();
      let lim = JSON.parse(localStorage.getItem(WEATHER_LIMIT_KEY)) || { date: '', count: 0 };
      if (lim.date !== todayStr) {
        lim = { date: todayStr, count: 0 };
        localStorage.setItem(WEATHER_LIMIT_KEY, JSON.stringify(lim));
      }
      return lim;
    }

    function saveWeatherLimiter(lim) {
      localStorage.setItem(WEATHER_LIMIT_KEY, JSON.stringify(lim));
    }

    function shouldUseWeatherCache(store) {
      const now = Date.now();
      const minMs = WEATHER_MIN_REFRESH_MINUTES * 60 * 1000;
      return (now - (store.lastFetchTs || 0)) < minMs;
    }

    async function qwFetchJson(path, paramsObj) {
      const params = new URLSearchParams(paramsObj || {});
      params.set('key', QW_API_KEY);
      const url = `https://${QW_API_HOST}${path}?${params.toString()}`;
      const res = await fetch(url, { method: 'GET' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    async function geocodePlace(place, store) {
      const geoKey = `${place.location}|${place.adm}`;
      if (store.geo && store.geo[geoKey] && store.geo[geoKey].locationId) {
        return store.geo[geoKey];
      }

      const data = await qwFetchJson('/geo/v2/city/lookup', {
        location: place.location,
        adm: place.adm,
        range: place.range || 'cn',
        number: '1',
        lang: 'zh'
      });

      if (String(data.code) !== "200" || !data.location || !data.location.length) {
        throw new Error(`Geo failed code=${data.code}`);
      }

      const loc = data.location[0];
      const geo = {
        locationId: loc.id,
        name: loc.name || place.displayName,
        adm1: loc.adm1 || '',
        adm2: loc.adm2 || '',
        adm3: loc.adm3 || ''
      };

      store.geo = store.geo || {};
      store.geo[geoKey] = geo;
      saveWeatherStore(store);
      return geo;
    }

    async function fetchPlaceWeather(place, store) {
      const geo = await geocodePlace(place, store);

      const [nowData, dailyData] = await Promise.all([
        qwFetchJson('/v7/weather/now', { location: geo.locationId, lang: 'zh', unit: 'm' }),
        qwFetchJson('/v7/weather/7d',  { location: geo.locationId, lang: 'zh', unit: 'm' })
      ]);

      if (String(nowData.code) !== "200" || !nowData.now) {
        throw new Error(`Now failed code=${nowData.code}`);
      }
      if (String(dailyData.code) !== "200" || !dailyData.daily || dailyData.daily.length < 4) {
        throw new Error(`7d failed code=${dailyData.code}`);
      }

      return {
        placeId: place.id,
        displayName: place.displayName,
        geoName: geo.name,
        now: nowData.now,
        nowUpdateTime: nowData.updateTime,
        daily: dailyData.daily,
        dailyUpdateTime: dailyData.updateTime
      };
    }

    function renderPlaceWeather(placeId, payload) {
      const t = hhmmFromISO(payload.nowUpdateTime) || hhmmFromISO(payload.dailyUpdateTime);
      document.getElementById(`${placeId}_update`).innerText = `更新时间：${t}`;

      const now = payload.now;
      const daily0 = payload.daily[0];

      const temp = safeNum(now.temp, null);
      const hum = safeNum(now.humidity, null);
      const wind = safeNum(now.windSpeed, null);

      document.getElementById(`${placeId}_icon`).innerText = iconEmojiFromQWCode(now.icon);
      document.getElementById(`${placeId}_temp`).innerText = (temp === null ? "--" : String(Math.round(temp)));
      document.getElementById(`${placeId}_text`).innerText = now.text || "--";
      document.getElementById(`${placeId}_hilo`).innerText = `最高/最低：${daily0.tempMax ?? "--"} / ${daily0.tempMin ?? "--"} °C`;
      document.getElementById(`${placeId}_hum`).innerText = (hum === null ? "--%" : `${hum}%`);
      document.getElementById(`${placeId}_wind`).innerText = (wind === null ? "-- m/s" : `${wind} m/s`);

      const labels = ["明天", "后天", "大后天"];
      for (let i = 1; i <= 3; i++) {
        const d = payload.daily[i];
        document.getElementById(`${placeId}_d${i}_label`).innerText = labels[i-1];
        document.getElementById(`${placeId}_d${i}_icon`).innerText = iconEmojiFromQWCode(d.iconDay || d.iconNight);
        document.getElementById(`${placeId}_d${i}_temp`).innerText = `${d.tempMax ?? "--"} / ${d.tempMin ?? "--"} °C`;
      }

      setCityBadge(placeId, "已更新", "#1f6d3b", "rgba(52,199,89,0.12)", "rgba(52,199,89,0.20)");
    }

    function renderFromWeatherCache(store) {
      const cache = store.cache || {};
      let renderedAny = false;

      for (const p of WEATHER_PLACES) {
        if (cache[p.id]) {
          renderPlaceWeather(p.id, cache[p.id]);
          renderedAny = true;
        } else {
          setCityPlaceholder(p.id);
          setCityBadge(p.id, "无缓存", "#6b5b00", "rgba(255,159,10,0.12)", "rgba(255,159,10,0.22)");
        }
      }

      if (renderedAny) {
        const dt = store.lastFetchTs ? new Date(store.lastFetchTs) : null;
        const hh = dt ? dt.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false }) : "--:--";
        setWeatherStatus(`使用缓存（上次：${hh}）`, "#ff9f0a");
      } else {
        setWeatherStatus("暂无缓存可用", "#ff3b30");
      }
    }

    async function initWeather() {
      for (const p of WEATHER_PLACES) setCityPlaceholder(p.id);
      setWeatherStatus("正在获取天气...", "#0071e3");

      const store = loadWeatherStore();
      const limiter = loadWeatherLimiter();

      if (shouldUseWeatherCache(store)) {
        renderFromWeatherCache(store);
        return;
      }

      if (limiter.count >= WEATHER_MAX_CALLS_PER_DAY) {
        renderFromWeatherCache(store);
        setWeatherStatus(`已达今日上限（${WEATHER_MAX_CALLS_PER_DAY}次），使用缓存`, "#86868b");
        for (const p of WEATHER_PLACES) setCityBadge(p.id, "今日上限", "#666", "rgba(134,134,139,0.16)", "rgba(134,134,139,0.25)");
        return;
      }

      try {
        for (const p of WEATHER_PLACES) setCityBadge(p.id, "更新中...", "#0a3d91", "rgba(0,113,227,0.10)", "rgba(0,113,227,0.18)");

        const results = await Promise.all(WEATHER_PLACES.map(p => fetchPlaceWeather(p, store)));

        store.cache = store.cache || {};
        for (const r of results) store.cache[r.placeId] = r;
        store.lastFetchTs = Date.now();
        saveWeatherStore(store);

        limiter.count += 1;
        saveWeatherLimiter(limiter);

        for (const r of results) renderPlaceWeather(r.placeId, r);

        setWeatherStatus(`已更新（今日第${limiter.count}次）`, "#34c759");
      } catch (err) {
        console.error(err);
        renderFromWeatherCache(store);
        setWeatherStatus("更新失败，使用缓存", "#ff3b30");
        for (const p of WEATHER_PLACES) setCityBadge(p.id, "更新失败", "#b00020", "rgba(255,59,48,0.10)", "rgba(255,59,48,0.20)");
      }
    }
  </script>
</body>
</html>
