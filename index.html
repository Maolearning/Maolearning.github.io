<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pro Pricing Calculator</title>
  <style>
    :root {
      --system-bg: #f5f5f7;
      --card-bg: rgba(255, 255, 255, 0.75);
      --primary-blue: #0071e3;
      --text-primary: #1d1d1f;
      --text-secondary: #86868b;
      --divider: rgba(0, 0, 0, 0.1);
      --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
      --radius-lg: 24px;
      --radius-sm: 12px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: url('https://images.unsplash.com/photo-1614850523459-c2f4c699c52e?q=80&w=2070&auto=format&fit=crop') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      padding: 92px 20px 20px;
      box-sizing: border-box;
    }

    /* ===== 顶部去水印工具栏 ===== */
    .wmbar-shell{
      position: fixed;
      top: 10px;
      left: 0;
      right: 0;
      z-index: 9999;
      display: flex;
      justify-content: center;
      padding: 0 20px;
      box-sizing: border-box;
      pointer-events: none;
    }

    .wmbar{
      pointer-events: auto;
      width: 100%;
      max-width: 440px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.72);
      border: 1px solid rgba(255, 255, 255, 0.78);
      box-shadow: 0 10px 30px rgba(0,0,0,0.10);
      backdrop-filter: blur(22px) saturate(170%);
      -webkit-backdrop-filter: blur(22px) saturate(170%);
    }

    @media (min-width: 980px){
      .wmbar{ max-width: 1180px; }
    }

    .wmbar::-webkit-scrollbar{ height: 6px; }
    .wmbar::-webkit-scrollbar-thumb{
      background: rgba(0,0,0,0.20);
      border-radius: 999px;
    }

    .wmctl{
      height: 36px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.88);
      font-family: inherit;
      font-size: 13px;
      color: #111;
      box-sizing: border-box;
    }

    .wm-file{
      min-width: 230px;
      max-width: 300px;
      padding: 6px 10px;
    }

    .wm-label{
      display: inline-flex;
      align-items: center;
      gap: 7px;
      color: #5e5e63;
      font-size: 12px;
      font-weight: 650;
      white-space: nowrap;
    }

    .wm-num{
      width: 92px;
      padding: 0 10px;
    }

    .wm-name{
      width: 180px;
      padding: 0 10px;
    }

    .wm-btn{
      height: 36px;
      border-radius: 10px;
      border: 1px solid rgba(0,113,227,0.30);
      background: linear-gradient(180deg, #2f8fff 0%, #0a75e8 100%);
      color: #fff;
      font-size: 12px;
      font-weight: 800;
      padding: 0 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform .14s ease, filter .14s ease, opacity .14s ease;
    }

    .wm-btn:hover:enabled{
      filter: brightness(1.03);
      transform: translateY(-1px);
    }

    .wm-btn:disabled{
      opacity: .5;
      cursor: not-allowed;
      transform: none;
    }

    @media (max-width: 640px){
      body { padding-top: 100px; }
      .wm-file{ min-width: 210px; max-width: 220px; }
      .wm-name{ width: 150px; }
    }

    .calculator-card {
      background: var(--card-bg);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      width: 100%;
      max-width: 440px;
      padding: 34px 26px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      box-sizing: border-box;
      border: 1px solid rgba(255, 255, 255, 0.6);
      margin-top: 20px;
      transition: max-width 0.4s ease, padding 0.4s ease;
    }

    h2 {
      text-align: center;
      font-weight: 650;
      font-size: 1.5rem;
      margin: 0 0 26px 0;
      letter-spacing: -0.5px;
      color: #111;
    }

    .calc-layout-grid {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* 桌面：三列等高（关键） */
    @media (min-width: 980px) {
      .calculator-card {
        max-width: 1180px;
        padding: 46px;
      }

      .calc-layout-grid {
        display: grid;
        grid-template-columns: 0.82fr 1.08fr 0.95fr;
        gap: 28px;
        align-items: stretch; /* 关键：拉伸到同高 */
      }

      h2 {
        grid-column: 1 / -1;
        margin-bottom: 18px;
        font-size: 1.9rem;
      }

      .divider-mobile { display: none; }
    }

    .divider-mobile {
      height: 1px;
      background: var(--divider);
      margin: 6px 0;
    }

    /* ===== 三列主模块统一容器（关键） ===== */
    .panel-card {
      background: rgba(255,255,255,0.28);
      padding: 18px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.55);
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      height: 100%;
      box-sizing: border-box;
    }
    @media (min-width: 980px) {
      .panel-card { padding: 22px; }
    }

    .input-group { margin-bottom: 22px; }

    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .segmented-control {
      display: flex;
      background: rgba(118, 118, 128, 0.12);
      padding: 2px;
      border-radius: 8px;
      width: 120px;
    }

    .segment-btn {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 0.75rem;
      font-weight: 550;
      padding: 4px 0;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .segment-btn.active {
      background: white;
      box-shadow: 0 3px 8px rgba(0,0,0,0.12), 0 3px 1px rgba(0,0,0,0.04);
      font-weight: 650;
    }

    .input-wrapper {
      position: relative;
      background: rgba(255, 255, 255, 0.6);
      border-radius: var(--radius-sm);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
      transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    .input-wrapper:focus-within, .input-wrapper.active-wrapper {
      box-shadow: inset 0 0 0 2px var(--primary-blue);
      background: #fff;
    }

    input[type="number"] {
      width: 100%;
      border: none;
      background: transparent;
      padding: 14px 16px;
      font-size: 1.1rem;
      font-weight: 400;
      border-radius: var(--radius-sm);
      outline: none;
      box-sizing: border-box;
      font-family: inherit;
      color: #000;
    }

    .unit-label {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 0.9rem;
      pointer-events: none;
    }

    .preset-group {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .preset-btn {
      flex: 1;
      min-width: 55px;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(0,0,0,0.05);
      border-radius: 8px;
      padding: 8px 0;
      font-size: 0.75rem;
      font-weight: 520;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .preset-btn:hover { background: rgba(255, 255, 255, 0.9); }
    .preset-btn:active { transform: scale(0.96); }

    .results-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 18px;
    }

    .result-box {
      background: rgba(255,255,255,0.82);
      padding: 18px;
      border-radius: 16px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.85);
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    }

    .res-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: block;
      margin-bottom: 6px;
    }

    .res-value {
      font-size: 1.35rem;
      font-weight: 650;
      letter-spacing: -0.5px;
      white-space: nowrap;
    }

    .cny-val { color: #ff3b30; }
    .usd-val { color: #34c759; }

    .virtual-keypad {
      background: rgba(230, 230, 235, 0.8);
      backdrop-filter: blur(10px);
      padding: 8px;
      border-radius: 16px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .key-btn {
      background: rgba(255,255,255,0.95);
      border: none;
      border-radius: 8px;
      height: 52px;
      font-size: 1.25rem;
      font-weight: 420;
      color: #000;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,0.15);
      transition: background 0.1s;
    }

    .key-btn:active { background: #e5e5e5; }
    .key-btn.bg-gray { background: rgba(255,255,255,0.6); }
    .key-btn.del { color: #ff3b30; font-size: 1.1rem; }

    .status-text {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-align: right;
      margin-top: -5px;
      height: 15px;
    }

    /* ====== Pricing History (right) ====== */
    .history-card{
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.75);
      border-radius: 18px;
      padding: 14px 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      margin-top: 10px;
    }

    .history-head{
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .history-title{
      font-size: 0.85rem;
      font-weight: 950;
      color: #222;
      letter-spacing: -0.2px;
    }

    .history-sub{
      font-size: 0.70rem;
      color: var(--text-secondary);
      margin-top: 3px;
      line-height: 1.25;
    }

    .history-actions{
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .mini-btn{
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.75);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.72rem;
      font-weight: 800;
      cursor: pointer;
      color: #111;
      transition: transform 0.12s, background 0.12s;
      user-select: none;
      white-space: nowrap;
    }
    .mini-btn:active{ transform: scale(0.97); }
    .mini-btn.primary{
      border-color: rgba(0,113,227,0.22);
      background: rgba(0,113,227,0.10);
      color: #0a3d91;
    }
    .mini-btn.danger{
      border-color: rgba(255,59,48,0.22);
      background: rgba(255,59,48,0.10);
      color: #b00020;
    }

    .history-list{
      display: grid;
      gap: 8px;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    details.history-item{
      background: rgba(255,255,255,0.62);
      border: 1px solid rgba(0,0,0,0.04);
      border-radius: 14px;
      padding: 10px 12px;
    }

    details.history-item summary{
      cursor: pointer;
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 0.78rem;
      font-weight: 900;
      color: #111;
    }
    details.history-item summary::-webkit-details-marker{ display:none; }

    .history-meta{
      font-size: 0.70rem;
      color: var(--text-secondary);
      font-weight: 750;
      white-space: nowrap;
    }

    .history-detail{
      margin-top: 10px;
      font-size: 0.73rem;
      color: #333;
      line-height: 1.35;
    }

    .history-detail .row{
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 4px 0;
      border-top: 1px dashed rgba(0,0,0,0.08);
    }
    .history-detail .row:first-child{ border-top: none; }
    .history-detail .k{ color: var(--text-secondary); font-weight: 800; }
    .history-detail .v{ font-weight: 900; color:#111; }

    /* ====== Math / fraction ====== */
    .math{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .frac{
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      line-height: 1.15;
      padding: 2px 6px;
      border-radius: 10px;
      background: rgba(255,255,255,0.45);
      border: 1px solid rgba(0,0,0,0.04);
    }
    .frac .top{
      padding: 0 4px 4px 4px;
      font-size: 0.82rem;
      color: #111;
      white-space: nowrap;
    }
    .frac .bar{
      width: 100%;
      height: 1px;
      background: rgba(0,0,0,0.35);
      margin: 0;
    }
    .frac .bottom{
      padding: 4px 4px 0 4px;
      font-size: 0.82rem;
      color: #111;
      white-space: nowrap;
    }

    /* ====== 左侧小计算器（改：表达式字号更大 + 卡片高度自适应等高） ====== */
    .mini-calc-card{
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mini-calc-head{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .mini-calc-title{
      font-size: 0.9rem;
      font-weight: 950;
      color: #222;
      letter-spacing: -0.2px;
    }

    .mini-calc-display{
      background: rgba(255,255,255,0.72);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 18px;
      padding: 12px 12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.65);
    }

    /* 这里是你要的：输入表达式字体变大 */
    .mini-calc-expr{
      font-size: 1.02rem; /* 原来 0.78rem，明显太小 */
      color: rgba(29,29,31,0.70);
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 18px;
    }

    .mini-calc-value{
      margin-top: 8px;
      font-size: 1.65rem;
      font-weight: 950;
      letter-spacing: -0.8px;
      color: #111;
      text-align: right;
    }

    /* 让按键区在桌面端尽量撑开，配合等高 */
    .mini-calc-pad{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      flex: 1 1 auto;          /* 关键：可伸缩占据高度 */
      align-content: start;    /* 避免拉伸到过大间距 */
    }

    .calc-btn{
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 14px;
      height: 54px;
      font-size: 1.1rem;
      font-weight: 800;
      cursor: pointer;
      color: #111;
      box-shadow: 0 1px 0 rgba(0,0,0,0.12);
      transition: transform 0.12s, background 0.12s;
      user-select: none;
    }
    .calc-btn:active{ transform: scale(0.97); background: rgba(235,235,235,0.95); }
    .calc-btn.op{
      background: rgba(0,113,227,0.10);
      border-color: rgba(0,113,227,0.18);
      color: #0a3d91;
    }
    .calc-btn.warn{
      background: rgba(255,159,10,0.12);
      border-color: rgba(255,159,10,0.20);
      color: #6b4a00;
    }
    .calc-btn.danger{
      background: rgba(255,59,48,0.10);
      border-color: rgba(255,59,48,0.18);
      color: #b00020;
    }
    .calc-btn.equal{
      background: rgba(52,199,89,0.12);
      border-color: rgba(52,199,89,0.20);
      color: #1f6d3b;
    }
    .calc-btn.wide{ grid-column: span 2; }

    .mini-calc-history{
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.04);
      border-radius: 16px;
      padding: 10px 10px;
    }

    .mini-calc-history-title{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .mini-calc-history-title b{
      font-size: 0.78rem;
      font-weight: 950;
      color: #222;
    }
    .mini-calc-history-title span{
      font-size: 0.70rem;
      color: var(--text-secondary);
      font-weight: 800;
    }

    .mini-calc-history-list{
      display:grid;
      gap: 6px;
      max-height: 160px;
      overflow: auto;
    }
    @media (min-width: 980px) {
      .mini-calc-history-list{ max-height: 180px; }
    }

    .calc-h-item{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      background: rgba(255,255,255,0.70);
      border: 1px solid rgba(0,0,0,0.04);
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
    }
    .calc-h-expr{
      font-size: 0.76rem;
      color: #111;
      font-weight: 900;
      max-width: 70%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .calc-h-res{
      font-size: 0.76rem;
      color: #1f6d3b;
      font-weight: 950;
      white-space: nowrap;
    }

    /* ====== 全宽模块（公式 & 天气统一风格） ====== */
    .fullwidth-section{
      margin-top: 22px;
      padding-top: 18px;
      border-top: 1px solid var(--divider);
    }

    .fullwidth-card{
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.75);
      border-radius: 20px;
      padding: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      backdrop-filter: blur(22px) saturate(180%);
      -webkit-backdrop-filter: blur(22px) saturate(180%);
    }

    .fullwidth-head{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .fullwidth-title{
      font-size: 0.9rem;
      font-weight: 900;
      color: #222;
      letter-spacing: -0.2px;
    }

    /* 公式模块内部 */
    .formula-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 980px) {
      .formula-grid{
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
    }
    .formula-pane{
      background: rgba(255,255,255,0.60);
      border: 1px solid rgba(0,0,0,0.04);
      border-radius: 18px;
      padding: 14px;
    }
    .formula-pane-title{
      font-size: 0.82rem;
      font-weight: 950;
      color: #222;
      margin-bottom: 10px;
    }

    .eq-row{
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0;
    }

    .eq-label{
      font-size: 0.8rem;
      font-weight: 800;
      color: #222;
    }

    .eq-equals{
      font-size: 0.95rem;
      font-weight: 800;
      color: #444;
      margin: 0 4px;
    }

    .eq-result{
      font-size: 0.9rem;
      font-weight: 900;
      color: #111;
    }

    .subnote{
      font-size: 0.72rem;
      color: #666;
      margin-top: 2px;
      line-height: 1.35;
    }

    /* ====== Weather module ====== */
    .weather-grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 980px) {
      .weather-grid{
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
    }

    .weather-status{
      font-size: 0.72rem;
      color: var(--text-secondary);
      text-align: right;
    }

    .city-weather-card{
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(255,255,255,0.85);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    }

    .city-head{
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .city-name{
      font-size: 0.85rem;
      font-weight: 900;
      color: #111;
      letter-spacing: -0.2px;
    }

    .city-update{
      font-size: 0.72rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .city-badge{
      font-size: 0.72rem;
      font-weight: 800;
      color: #0a3d91;
      background: rgba(0,113,227,0.10);
      border: 1px solid rgba(0,113,227,0.18);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .city-hero{
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }

    .wx-icon{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.7);
    }

    .city-temp{
      font-size: 1.45rem;
      font-weight: 950;
      letter-spacing: -0.8px;
      color: #111;
      line-height: 1.0;
    }
    .city-temp .deg{
      font-size: 0.95rem;
      font-weight: 850;
      color: #333;
      margin-left: 2px;
    }

    .city-desc{
      font-size: 0.82rem;
      color: #333;
      font-weight: 850;
      margin-top: 2px;
    }

    .city-hilo{
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 2px;
      white-space: nowrap;
    }

    .city-metrics{
      display: grid;
      gap: 8px;
      justify-items: end;
    }

    .metric{
      display: flex;
      gap: 8px;
      align-items: baseline;
      white-space: nowrap;
    }

    .metric-label{
      font-size: 0.72rem;
      color: var(--text-secondary);
      font-weight: 800;
    }

    .metric-val{
      font-size: 0.78rem;
      color: #111;
      font-weight: 900;
    }

    .forecast-strip{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .day-card{
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.04);
      border-radius: 14px;
      padding: 10px 10px;
      text-align: center;
    }

    .day-label{
      font-size: 0.72rem;
      font-weight: 900;
      color: #222;
      margin-bottom: 6px;
      white-space: nowrap;
    }

    .day-icon{
      font-size: 1.05rem;
      margin-bottom: 6px;
    }

    .day-temp{
      font-size: 0.75rem;
      color: #111;
      font-weight: 900;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="wmbar-shell">
    <div class="wmbar" id="wmToolbar">
      <input class="wmctl wm-file" id="wmFileInput" type="file" accept="image/jpeg,image/png,image/webp" />
      <label class="wm-label">
        目标KB
        <input class="wmctl wm-num" id="wmTargetKb" type="number" min="30" max="3000" value="300" />
      </label>
      <label class="wm-label">
        文件名
        <input class="wmctl wm-name" id="wmDownloadName" type="text" placeholder="例如：我的图片" />
      </label>
      <button class="wm-btn" id="wmRunBtn" disabled>去水印+压缩+下载</button>
    </div>
  </div>

  <div class="calculator-card">
    <h2>Pricing Calc</h2>

    <div class="calc-layout-grid">

      <!-- 左侧：小计算器（等高） -->
      <div class="panel-card mini-calc-card">
        <div class="mini-calc-head">
          <div class="mini-calc-title">小计算器</div>
          <div class="history-actions">
            <button class="mini-btn danger" onclick="clearCalcHistory()">清空历史</button>
          </div>
        </div>

        <div class="mini-calc-display">
          <div class="mini-calc-expr math" id="calcExpr"> </div>
          <div class="mini-calc-value math" id="calcValue">0</div>
        </div>

        <div class="mini-calc-pad">
          <button class="calc-btn danger" onclick="calcPress('AC')">AC</button>
          <button class="calc-btn warn" onclick="calcPress('DEL')">⌫</button>
          <button class="calc-btn warn" onclick="calcPress('%')">%</button>
          <button class="calc-btn op" onclick="calcPress('/')">÷</button>

          <button class="calc-btn" onclick="calcPress('7')">7</button>
          <button class="calc-btn" onclick="calcPress('8')">8</button>
          <button class="calc-btn" onclick="calcPress('9')">9</button>
          <button class="calc-btn op" onclick="calcPress('*')">×</button>

          <button class="calc-btn" onclick="calcPress('4')">4</button>
          <button class="calc-btn" onclick="calcPress('5')">5</button>
          <button class="calc-btn" onclick="calcPress('6')">6</button>
          <button class="calc-btn op" onclick="calcPress('-')">−</button>

          <button class="calc-btn" onclick="calcPress('1')">1</button>
          <button class="calc-btn" onclick="calcPress('2')">2</button>
          <button class="calc-btn" onclick="calcPress('3')">3</button>
          <button class="calc-btn op" onclick="calcPress('+')">+</button>

          <button class="calc-btn warn" onclick="calcPress('(')">(</button>
          <button class="calc-btn warn" onclick="calcPress(')')">)</button>
          <button class="calc-btn" onclick="calcPress('0')">0</button>
          <button class="calc-btn" onclick="calcPress('.')">.</button>

          <button class="calc-btn equal wide" onclick="calcPress('=')">=</button>
          <button class="calc-btn warn wide" onclick="calcUseLastResult()">Ans</button>
        </div>

        <div class="mini-calc-history">
          <div class="mini-calc-history-title">
            <b>最近 5 条</b>
            <span>点一下回填</span>
          </div>
          <div class="mini-calc-history-list" id="calcHistoryList"></div>
        </div>
      </div>

      <!-- 中间：成本输入（等高） -->
      <div class="panel-card">
        <div class="input-group">
          <div class="label-row">
            <label>原始成本</label>
            <div class="segmented-control">
              <button class="segment-btn active" id="btn-cny" onclick="setCostCurrency('CNY')">¥ CNY</button>
              <button class="segment-btn" id="btn-usd" onclick="setCostCurrency('USD')">$ USD</button>
            </div>
          </div>

          <div class="input-wrapper" id="wrap-inputValue">
            <input type="number" id="inputValue" placeholder="0.00" oninput="calculateDebounced()" onfocus="focusInput('inputValue')">
            <span class="unit-label" id="costUnitLabel">CNY</span>
          </div>
        </div>

        <div class="input-group">
          <label>目标利润率 (%)</label>
          <div class="input-wrapper" id="wrap-marginValue">
            <input type="number" id="marginValue" value="40" oninput="calculateDebounced()" onfocus="focusInput('marginValue')">
            <span class="unit-label">%</span>
          </div>
          <div class="preset-group">
            <button class="preset-btn" onclick="setPreset('marginValue', 10)">10%</button>
            <button class="preset-btn" onclick="setPreset('marginValue', 20)">20%</button>
            <button class="preset-btn" onclick="setPreset('marginValue', 30)">30%</button>
            <button class="preset-btn" onclick="setPreset('marginValue', 40)">40%</button>
            <button class="preset-btn" onclick="setPreset('marginValue', 50)">50%</button>
          </div>
        </div>

        <div class="input-group">
          <label>固定运费/杂费 (CNY)</label>
          <div class="input-wrapper" id="wrap-shippingCost">
            <input type="number" id="shippingCost" value="0.5" step="0.1" oninput="calculateDebounced()" onfocus="focusInput('shippingCost')">
            <span class="unit-label">¥</span>
          </div>
          <div class="preset-group">
            <button class="preset-btn" onclick="setPreset('shippingCost', 0)">0</button>
            <button class="preset-btn" onclick="setPreset('shippingCost', 0.1)">0.1</button>
            <button class="preset-btn" onclick="setPreset('shippingCost', 0.2)">0.2</button>
            <button class="preset-btn" onclick="setPreset('shippingCost', 0.3)">0.3</button>
            <button class="preset-btn" onclick="setPreset('shippingCost', 0.4)">0.4</button>
            <button class="preset-btn" onclick="setPreset('shippingCost', 0.5)">0.5</button>
          </div>
        </div>

        <div class="input-group">
          <label style="display:flex; justify-content:space-between;">
            汇率 (CNY/USD)
            <span class="status-text" id="apiStatus">初始化...</span>
          </label>
          <div class="input-wrapper" id="wrap-exchangeRate">
            <input type="number" id="exchangeRate" value="7.25" step="0.001" oninput="manualRateLock(); calculateDebounced()" onfocus="focusInput('exchangeRate')">
          </div>
        </div>

        <div class="input-group" style="margin-top:-6px;">
          <label>汇率安全垫 (%)</label>
          <div class="input-wrapper" id="wrap-rateBuffer">
            <input type="number" id="rateBuffer" value="1.5" step="0.1" oninput="calculateDebounced()" onfocus="focusInput('rateBuffer')">
            <span class="unit-label">%</span>
          </div>
          <div class="preset-group">
            <button class="preset-btn" onclick="setPreset('rateBuffer', 0)">0%</button>
            <button class="preset-btn" onclick="setPreset('rateBuffer', 1)">1%</button>
            <button class="preset-btn" onclick="setPreset('rateBuffer', 1.5)">1.5%</button>
            <button class="preset-btn" onclick="setPreset('rateBuffer', 2)">2%</button>
            <button class="preset-btn" onclick="setPreset('rateBuffer', 3)">3%</button>
          </div>
        </div>

        <div class="input-group" style="margin-top:-6px;">
          <label>平台手续费 (%)</label>
          <div class="input-wrapper" id="wrap-platformFee">
            <input type="number" id="platformFee" value="0.3" step="0.1" oninput="calculateDebounced()" onfocus="focusInput('platformFee')">
            <span class="unit-label">%</span>
          </div>
          <div class="preset-group">
            <button class="preset-btn" onclick="setPreset('platformFee', 0)">0%</button>
            <button class="preset-btn" onclick="setPreset('platformFee', 0.3)">0.3%</button>
            <button class="preset-btn" onclick="setPreset('platformFee', 0.5)">0.5%</button>
            <button class="preset-btn" onclick="setPreset('platformFee', 1)">1%</button>
            <button class="preset-btn" onclick="setPreset('platformFee', 2)">2%</button>
          </div>
        </div>
      </div>

      <div class="divider-mobile"></div>

      <!-- 右侧：结果 + 历史（等高） -->
      <div class="panel-card">
        <div class="results-container">
          <div class="result-box">
            <span class="res-label">人民币 (CNY)</span>
            <span class="res-value cny-val" id="resCNY">¥0.0000</span>
          </div>
          <div class="result-box">
            <span class="res-label">美元 (USD)</span>
            <span class="res-value usd-val" id="resUSD">$0.0000</span>
          </div>
        </div>

        <div class="history-card">
          <div class="history-head">
            <div>
              <div class="history-title">成本计算历史（最近 5 条）</div>
              <div class="history-sub">
                自动保存：停止输入 <span class="math">0.7s</span> 后保存（结果有效时）<br/>
                也可点「保存本次」手动记录
              </div>
            </div>
            <div class="history-actions">
              <button class="mini-btn primary" onclick="savePricingHistory(true)">保存本次</button>
              <button class="mini-btn danger" onclick="clearPricingHistory()">清空</button>
            </div>
          </div>
          <ul class="history-list" id="pricingHistoryList"></ul>
        </div>

        <div class="virtual-keypad">
          <button class="key-btn" onclick="pressKey('1')">1</button>
          <button class="key-btn" onclick="pressKey('2')">2</button>
          <button class="key-btn" onclick="pressKey('3')">3</button>
          <button class="key-btn" onclick="pressKey('4')">4</button>
          <button class="key-btn" onclick="pressKey('5')">5</button>
          <button class="key-btn" onclick="pressKey('6')">6</button>
          <button class="key-btn" onclick="pressKey('7')">7</button>
          <button class="key-btn" onclick="pressKey('8')">8</button>
          <button class="key-btn" onclick="pressKey('9')">9</button>
          <button class="key-btn bg-gray" onclick="pressKey('.')">.</button>
          <button class="key-btn" onclick="pressKey('0')">0</button>
          <button class="key-btn bg-gray del" onclick="pressDel()">⌫</button>
        </div>
      </div>
    </div>

    <!-- ✅ 全宽：当前计算公式（从右侧移到这里） -->
    <div class="fullwidth-section">
      <div class="fullwidth-card">
        <div class="fullwidth-head">
          <div class="fullwidth-title">当前计算公式（分式展示）</div>
        </div>

        <div class="formula-grid">
          <div class="formula-pane">
            <div class="formula-pane-title">人民币售价 (CNY)</div>

            <div class="eq-row">
              <span class="eq-label">人民币售价</span>
              <span class="eq-equals">=</span>
              <span class="frac math">
                <span class="top">总成本（人民币）</span>
                <span class="bar"></span>
                <span class="bottom">(1 − 目标利润率) × (1 − 平台手续费率)</span>
              </span>
              <span class="eq-equals">=</span>
              <span class="eq-result math" id="cnyResultText">—</span>
            </div>
            <div class="subnote math" id="cnySubText">—</div>
          </div>

          <div class="formula-pane">
            <div class="formula-pane-title">美元售价 (USD)</div>

            <div class="eq-row">
              <span class="eq-label">美元售价</span>
              <span class="eq-equals">=</span>
              <span class="frac math">
                <span class="top">人民币售价</span>
                <span class="bar"></span>
                <span class="bottom">汇率（CNY/USD） × (1 − 汇率安全垫)</span>
              </span>
              <span class="eq-equals">=</span>
              <span class="eq-result math" id="usdResultText">—</span>
            </div>
            <div class="subnote math" id="usdSubText">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 天气模块（保持全宽） -->
    <div class="fullwidth-section">
      <div class="fullwidth-card">
        <div class="fullwidth-head">
          <div class="fullwidth-title">天气预报（今日 + 未来三天）</div>
          <div class="weather-status" id="weatherStatus">初始化...</div>
        </div>

        <div class="weather-grid">
          <!-- 道真 -->
          <div class="city-weather-card" id="city-dz">
            <div class="city-head">
              <div>
                <div class="city-name" id="dz_name">贵州·遵义·道真县</div>
                <div class="city-update" id="dz_update">更新时间：--:--</div>
              </div>
              <div class="city-badge" id="dz_badge">今日</div>
            </div>

            <div class="city-hero">
              <div class="wx-icon" id="dz_icon">⛅</div>
              <div>
                <div class="city-temp"><span id="dz_temp">--</span><span class="deg">°C</span></div>
                <div class="city-desc" id="dz_text">--</div>
                <div class="city-hilo" id="dz_hilo">最高/最低：-- / -- °C</div>
              </div>
              <div class="city-metrics">
                <div class="metric"><span class="metric-label">湿度</span><span class="metric-val" id="dz_hum">--%</span></div>
                <div class="metric"><span class="metric-label">风速</span><span class="metric-val" id="dz_wind">-- m/s</span></div>
              </div>
            </div>

            <div class="forecast-strip">
              <div class="day-card">
                <div class="day-label" id="dz_d1_label">明天</div>
                <div class="day-icon" id="dz_d1_icon">—</div>
                <div class="day-temp" id="dz_d1_temp">-- / -- °C</div>
              </div>
              <div class="day-card">
                <div class="day-label" id="dz_d2_label">后天</div>
                <div class="day-icon" id="dz_d2_icon">—</div>
                <div class="day-temp" id="dz_d2_temp">-- / -- °C</div>
              </div>
              <div class="day-card">
                <div class="day-label" id="dz_d3_label">大后天</div>
                <div class="day-icon" id="dz_d3_icon">—</div>
                <div class="day-temp" id="dz_d3_temp">-- / -- °C</div>
              </div>
            </div>
          </div>

          <!-- 南岗 -->
          <div class="city-weather-card" id="city-ng">
            <div class="city-head">
              <div>
                <div class="city-name" id="ng_name">黑龙江·哈尔滨·南岗区</div>
                <div class="city-update" id="ng_update">更新时间：--:--</div>
              </div>
              <div class="city-badge" id="ng_badge">今日</div>
            </div>

            <div class="city-hero">
              <div class="wx-icon" id="ng_icon">⛅</div>
              <div>
                <div class="city-temp"><span id="ng_temp">--</span><span class="deg">°C</span></div>
                <div class="city-desc" id="ng_text">--</div>
                <div class="city-hilo" id="ng_hilo">最高/最低：-- / -- °C</div>
              </div>
              <div class="city-metrics">
                <div class="metric"><span class="metric-label">湿度</span><span class="metric-val" id="ng_hum">--%</span></div>
                <div class="metric"><span class="metric-label">风速</span><span class="metric-val" id="ng_wind">-- m/s</span></div>
              </div>
            </div>

            <div class="forecast-strip">
              <div class="day-card">
                <div class="day-label" id="ng_d1_label">明天</div>
                <div class="day-icon" id="ng_d1_icon">—</div>
                <div class="day-temp" id="ng_d1_temp">-- / -- °C</div>
              </div>
              <div class="day-card">
                <div class="day-label" id="ng_d2_label">后天</div>
                <div class="day-icon" id="ng_d2_icon">—</div>
                <div class="day-temp" id="ng_d2_temp">-- / -- °C</div>
              </div>
              <div class="day-card">
                <div class="day-label" id="ng_d3_label">大后天</div>
                <div class="day-icon" id="ng_d3_icon">—</div>
                <div class="day-temp" id="ng_d3_temp">-- / -- °C</div>
              </div>
            </div>
          </div>
        </div>

        <div class="weather-status" style="margin-top:10px;">
          提示：这是前端直连 API 的实现方式；如果页面对外公开，建议用 Worker/后端代理隐藏 Key。
        </div>
      </div>
    </div>

  </div>

  <script>
    // =========================
    // Exchange rate API (existing)
    // =========================
    const API_KEY = '598fef75b65d4c4074c91fe0';
    const STORAGE_KEY = 'rate_limiter_v1';

    // =========================
    // QWeather (HeFeng) config
    // =========================
    const QW_API_KEY = '758f01261e644865a765152b67e087cf';
    const QW_API_HOST = 'ku62b6xbgd.re.qweatherapi.com';

    const WEATHER_CACHE_KEY = 'weather_cache_v1';
    const WEATHER_LIMIT_KEY = 'weather_limiter_v1';
    const WEATHER_MAX_CALLS_PER_DAY = 20;
    const WEATHER_MIN_REFRESH_MINUTES = 30;

    const WEATHER_PLACES = [
      { id: 'dz', displayName: '贵州·遵义·道真县', location: '道真', adm: '遵义', range: 'cn' },
      { id: 'ng', displayName: '黑龙江·哈尔滨·南岗区', location: '南岗', adm: '哈尔滨', range: 'cn' }
    ];

    // =========================
    // Pricing history config
    // =========================
    const PRICING_HISTORY_KEY = 'pricing_history_v1';
    const PRICING_HISTORY_MAX = 5;
    const PRICING_AUTOSAVE_DEBOUNCE_MS = 700;

    // =========================
    // Mini calculator history config
    // =========================
    const CALC_HISTORY_KEY = 'mini_calc_history_v1';
    const CALC_HISTORY_MAX = 5;

    let activeInputId = 'inputValue';
    let costCurrency = 'CNY';

    // For debounced autosave
    let autosaveTimer = null;
    let lastSnapshotKey = "";

    // Mini calculator state
    let calcExpression = "";
    let calcLastResult = 0;

    window.onload = function() {
      checkAndFetchRate();
      focusInput('inputValue');
      initWeather();

      renderPricingHistory();
      renderCalcHistory();
      updateCalcDisplay();
    };

    // =========================
    // Exchange Rate
    // =========================
    function checkAndFetchRate() {
      const statusEl = document.getElementById('apiStatus');
      const todayStr = new Date().toDateString();
      let store = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { date: '', count: 0, rate: 7.25 };

      if (store.date !== todayStr) {
        store.date = todayStr;
        store.count = 0;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
      }

      if (store.count < 5) {
        statusEl.innerText = "正在更新汇率...";
        fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/latest/USD`)
          .then(res => res.json())
          .then(data => {
            if (data.conversion_rates && data.conversion_rates.CNY) {
              const newRate = data.conversion_rates.CNY;
              document.getElementById('exchangeRate').value = newRate;
              calculateDebounced();
              store.count += 1;
              store.rate = newRate;
              localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
              statusEl.innerText = `已更新 (今日第${store.count}次)`;
              statusEl.style.color = "#34c759";
            } else {
              throw new Error("No CNY rate in response");
            }
          })
          .catch(err => {
            console.error(err);
            document.getElementById('exchangeRate').value = store.rate;
            statusEl.innerText = "更新失败，使用缓存";
            statusEl.style.color = "#ff3b30";
            calculateDebounced();
          });
      } else {
        document.getElementById('exchangeRate').value = store.rate;
        calculateDebounced();
        statusEl.innerText = "已达今日上限 (5次)";
        statusEl.style.color = "#86868b";
      }
    }

    function manualRateLock() {
      const statusEl = document.getElementById('apiStatus');
      statusEl.innerText = "手动输入";
      statusEl.style.color = "#ff9f0a";
    }

    // =========================
    // UI helpers (cost inputs)
    // =========================
    function setCostCurrency(currency) {
      costCurrency = currency;
      document.getElementById('btn-cny').classList.remove('active');
      document.getElementById('btn-usd').classList.remove('active');
      document.getElementById('btn-' + currency.toLowerCase()).classList.add('active');
      document.getElementById('costUnitLabel').innerText = currency;
      calculateDebounced();
    }

    function focusInput(id) {
      activeInputId = id;
      document.querySelectorAll('.input-wrapper').forEach(el => el.classList.remove('active-wrapper'));
      const wrapper = document.getElementById('wrap-' + id);
      if(wrapper) wrapper.classList.add('active-wrapper');
    }

    function setPreset(id, val) {
      document.getElementById(id).value = val;
      focusInput(id);
      calculateDebounced();
    }

    function pressKey(key) {
      const el = document.getElementById(activeInputId);
      if (!el) return;
      if (el.value === '0' && key !== '.') el.value = key;
      else {
        if (key === '.' && el.value.includes('.')) return;
        el.value += key;
      }
      calculateDebounced();
    }

    function pressDel() {
      const el = document.getElementById(activeInputId);
      if (!el) return;
      el.value = el.value.slice(0, -1);
      calculateDebounced();
    }

    function fmt4(x) {
      if (!isFinite(x)) return "NaN";
      return Number(x).toFixed(4);
    }

    function fmtCNY(x) {
      if (!isFinite(x)) return "¥0.0000";
      return "¥" + Number(x).toLocaleString('zh-CN', {minimumFractionDigits: 4, maximumFractionDigits: 4});
    }

    function fmtUSD(x) {
      if (!isFinite(x)) return "$0.0000";
      return "$" + Number(x).toLocaleString('en-US', {minimumFractionDigits: 4, maximumFractionDigits: 4});
    }

    // =========================
    // Calculate + debounced autosave
    // =========================
    function calculateDebounced() {
      calculate();
      if (autosaveTimer) clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => {
        savePricingHistory(false);
      }, PRICING_AUTOSAVE_DEBOUNCE_MS);
    }

    function getPricingSnapshot() {
      const rawInputValue = parseFloat(document.getElementById('inputValue').value);
      const targetProfitMarginPercent = parseFloat(document.getElementById('marginValue').value) || 40;
      const fixedShippingAndMiscCostCNY = parseFloat(document.getElementById('shippingCost').value);
      const exchangeRateCNYPerUSD = parseFloat(document.getElementById('exchangeRate').value);

      const exchangeRateSafetyBufferPercent = parseFloat(document.getElementById('rateBuffer').value) || 0;
      const platformFeePercent = parseFloat(document.getElementById('platformFee').value) || 0;

      if (!isFinite(rawInputValue)) return { valid: false };

      const finalFixedShippingAndMiscCostCNY = isFinite(fixedShippingAndMiscCostCNY) ? fixedShippingAndMiscCostCNY : 0.5;

      let totalCostCNY = 0;
      if (costCurrency === 'USD') {
        if (isFinite(exchangeRateCNYPerUSD) && exchangeRateCNYPerUSD !== 0) {
          totalCostCNY = (rawInputValue * exchangeRateCNYPerUSD) + finalFixedShippingAndMiscCostCNY;
        } else {
          return { valid: false };
        }
      } else {
        totalCostCNY = rawInputValue + finalFixedShippingAndMiscCostCNY;
      }

      const targetProfitMarginRate = targetProfitMarginPercent / 100;
      const platformFeeRate = platformFeePercent / 100;
      const exchangeRateSafetyBufferRate = exchangeRateSafetyBufferPercent / 100;

      const cnyDivisor = (1 - targetProfitMarginRate) * (1 - platformFeeRate);
      if (!(cnyDivisor > 0)) return { valid: false };

      const pricingResultCNY = totalCostCNY / cnyDivisor;

      const effectiveExchangeRateCNYPerUSD = exchangeRateCNYPerUSD * (1 - exchangeRateSafetyBufferRate);
      if (!(isFinite(effectiveExchangeRateCNYPerUSD) && effectiveExchangeRateCNYPerUSD > 0)) return { valid: false };

      const pricingResultUSD = pricingResultCNY / effectiveExchangeRateCNYPerUSD;

      return {
        valid: isFinite(pricingResultCNY) && isFinite(pricingResultUSD),
        timestamp: Date.now(),
        inputCurrency: costCurrency,
        inputValue: rawInputValue,

        targetProfitMarginPercent,
        fixedShippingAndMiscCostCNY: finalFixedShippingAndMiscCostCNY,
        exchangeRateCNYPerUSD,
        exchangeRateSafetyBufferPercent,
        platformFeePercent,

        totalCostCNY,
        pricingResultCNY,
        pricingResultUSD
      };
    }

    function calculate() {
      const snap = getPricingSnapshot();

      if (!snap.valid) {
        document.getElementById('resCNY').innerText = "¥0.0000";
        document.getElementById('resUSD').innerText = "$0.0000";
        document.getElementById('cnyResultText').innerText = "—";
        document.getElementById('usdResultText').innerText = "—";
        document.getElementById('cnySubText').innerText = "—";
        document.getElementById('usdSubText').innerText = "—";
        return;
      }

      document.getElementById('resCNY').innerText = fmtCNY(snap.pricingResultCNY);
      document.getElementById('resUSD').innerText = fmtUSD(snap.pricingResultUSD);

      document.getElementById('cnyResultText').innerText = `${fmt4(snap.pricingResultCNY)} CNY`;
      document.getElementById('usdResultText').innerText = `${fmt4(snap.pricingResultUSD)} USD`;

      const targetProfitMarginRate = snap.targetProfitMarginPercent / 100;
      const platformFeeRate = snap.platformFeePercent / 100;
      const exchangeRateSafetyBufferRate = snap.exchangeRateSafetyBufferPercent / 100;

      document.getElementById('cnySubText').innerText =
        `代入：人民币售价 = ${fmt4(snap.totalCostCNY)} ÷ ((1 − ${fmt4(targetProfitMarginRate)}) × (1 − ${fmt4(platformFeeRate)}))`;

      document.getElementById('usdSubText').innerText =
        `代入：美元售价 = ${fmt4(snap.pricingResultCNY)} ÷ (${fmt4(snap.exchangeRateCNYPerUSD)} × (1 − ${fmt4(exchangeRateSafetyBufferRate)}))`;
    }

    // =========================
    // Pricing history
    // =========================
    function loadPricingHistory() {
      return JSON.parse(localStorage.getItem(PRICING_HISTORY_KEY)) || [];
    }

    function savePricingHistoryStore(arr) {
      localStorage.setItem(PRICING_HISTORY_KEY, JSON.stringify(arr));
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function formatInputOriginal(entry) {
      const v = isFinite(entry.inputValue) ? entry.inputValue : 0;
      const val = Number(v).toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      return `${val} ${entry.inputCurrency}`;
    }

    function snapshotKeyForDedupe(snap) {
      return [
        snap.inputCurrency,
        Number(snap.inputValue).toFixed(6),
        Number(snap.targetProfitMarginPercent).toFixed(3),
        Number(snap.fixedShippingAndMiscCostCNY).toFixed(6),
        Number(snap.exchangeRateCNYPerUSD).toFixed(6),
        Number(snap.exchangeRateSafetyBufferPercent).toFixed(3),
        Number(snap.platformFeePercent).toFixed(3),
        Number(snap.pricingResultUSD).toFixed(6)
      ].join("|");
    }

    function savePricingHistory(isManual) {
      const snap = getPricingSnapshot();
      if (!snap.valid) return;

      const key = snapshotKeyForDedupe(snap);
      if (!isManual) {
        if (key === lastSnapshotKey) return;
      }

      const history = loadPricingHistory();
      if (history.length > 0) {
        const topKey = snapshotKeyForDedupe(history[0]);
        if (topKey === key) {
          lastSnapshotKey = key;
          return;
        }
      }

      history.unshift(snap);
      savePricingHistoryStore(history.slice(0, PRICING_HISTORY_MAX));

      lastSnapshotKey = key;
      renderPricingHistory();
    }

    function clearPricingHistory() {
      localStorage.removeItem(PRICING_HISTORY_KEY);
      renderPricingHistory();
    }

    function renderPricingHistory() {
      const listEl = document.getElementById('pricingHistoryList');
      const history = loadPricingHistory();

      listEl.innerHTML = "";
      if (!history.length) {
        const empty = document.createElement('div');
        empty.style.fontSize = "0.74rem";
        empty.style.color = "var(--text-secondary)";
        empty.style.fontWeight = "800";
        empty.style.padding = "8px 2px";
        empty.innerText = "暂无记录（计算一次后会自动保存）";
        listEl.appendChild(empty);
        return;
      }

      for (const entry of history) {
        const li = document.createElement('li');

        const det = document.createElement('details');
        det.className = 'history-item';

        const sum = document.createElement('summary');

        const left = document.createElement('span');
        left.innerText = `${formatInputOriginal(entry)} → ${fmtUSD(entry.pricingResultUSD)}`;

        const right = document.createElement('span');
        right.className = 'history-meta';
        right.innerText = formatTime(entry.timestamp);

        sum.appendChild(left);
        sum.appendChild(right);

        const detail = document.createElement('div');
        detail.className = 'history-detail';

        const rows = [
          ["原始输入币种", entry.inputCurrency],
          ["原始输入数值", Number(entry.inputValue).toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 6})],
          ["目标利润率 (%)", entry.targetProfitMarginPercent],
          ["固定运费/杂费 (CNY)", entry.fixedShippingAndMiscCostCNY],
          ["汇率 (CNY/USD)", entry.exchangeRateCNYPerUSD],
          ["汇率安全垫 (%)", entry.exchangeRateSafetyBufferPercent],
          ["平台手续费 (%)", entry.platformFeePercent],
          ["总成本（人民币）", fmt4(entry.totalCostCNY)],
          ["人民币售价", fmt4(entry.pricingResultCNY)],
          ["美元售价", fmt4(entry.pricingResultUSD)]
        ];

        for (const [k, v] of rows) {
          const r = document.createElement('div');
          r.className = 'row';

          const kk = document.createElement('div');
          kk.className = 'k';
          kk.innerText = k;

          const vv = document.createElement('div');
          vv.className = 'v';
          vv.innerText = String(v);

          r.appendChild(kk);
          r.appendChild(vv);
          detail.appendChild(r);
        }

        det.appendChild(sum);
        det.appendChild(detail);
        li.appendChild(det);
        listEl.appendChild(li);
      }
    }

    // =========================
    // Mini Calculator
    // =========================
    function updateCalcDisplay() {
      const exprEl = document.getElementById('calcExpr');
      const valEl = document.getElementById('calcValue');
      exprEl.innerText = calcExpression.trim() ? calcExpression : " ";
      valEl.innerText = String(calcLastResult);
    }

    function calcPress(key) {
      if (key === 'AC') {
        calcExpression = "";
        calcLastResult = 0;
        updateCalcDisplay();
        return;
      }

      if (key === 'DEL') {
        calcExpression = calcExpression.slice(0, -1);
        updateCalcDisplay();
        return;
      }

      if (key === '=') {
        const result = safeEvalExpression(calcExpression);
        if (result.ok) {
          calcLastResult = normalizeNumber(result.value);
          saveCalcHistory(calcExpression, calcLastResult);
          calcExpression = String(calcLastResult);
        } else {
          calcLastResult = "Error";
        }
        updateCalcDisplay();
        renderCalcHistory();
        return;
      }

      const last = calcExpression.slice(-1);
      const isOp = (ch) => ['+','-','*','/'].includes(ch);
      const isKeyOp = (ch) => ['+','-','*','/'].includes(ch);

      if (isKeyOp(key)) {
        if (calcExpression.trim() === "" && key !== '-') return;
        if (isOp(last)) {
          calcExpression = calcExpression.slice(0, -1) + key;
          updateCalcDisplay();
          return;
        }
      }

      if (key === '.') {
        const tail = calcExpression.split(/[\+\-\*\/\(\)\%]/).pop();
        if (tail.includes('.')) return;
      }

      calcExpression += key;
      updateCalcDisplay();
    }

    function calcUseLastResult() {
      if (calcLastResult === "Error") return;
      calcExpression += String(calcLastResult);
      updateCalcDisplay();
    }

    function normalizeNumber(x) {
      const n = Number(x);
      if (!isFinite(n)) return "Error";
      const s = n.toString();
      if (s.includes('e') || s.length > 14) return Number(n.toPrecision(12));
      return Number((Math.round(n * 1e12) / 1e12).toString());
    }

    function safeEvalExpression(expr) {
      try {
        const tokens = tokenize(expr);
        if (!tokens.length) return { ok: false, error: "Empty" };
        const rpn = toRPN(tokens);
        const val = evalRPN(rpn);
        if (!isFinite(val)) return { ok: false, error: "NaN" };
        return { ok: true, value: val };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    function tokenize(expr) {
      const cleaned = (expr || "").replace(/\s+/g, '');
      const out = [];
      let i = 0;
      const isDigit = (c) => c >= '0' && c <= '9';

      while (i < cleaned.length) {
        const c = cleaned[i];

        if (isDigit(c) || c === '.' || (c === '-' && (i === 0 || ['+','-','*','/','('].includes(cleaned[i-1])))) {
          let j = i;
          let hasDot = false;
          if (cleaned[j] === '-') j++;

          while (j < cleaned.length) {
            const cc = cleaned[j];
            if (isDigit(cc)) { j++; continue; }
            if (cc === '.') {
              if (hasDot) break;
              hasDot = true; j++; continue;
            }
            break;
          }

          const numStr = cleaned.slice(i, j);
          if (numStr === '-' || numStr === '.') throw new Error("Bad number");
          out.push({ type: 'num', value: Number(numStr) });
          i = j;
          continue;
        }

        if (['+','-','*','/','(',')','%'].includes(c)) {
          out.push({ type: 'op', value: c });
          i++;
          continue;
        }

        throw new Error("Invalid char");
      }
      return out;
    }

    function toRPN(tokens) {
      const output = [];
      const ops = [];
      const precedence = (op) => {
        if (op === '%') return 4;
        if (op === '*' || op === '/') return 3;
        if (op === '+' || op === '-') return 2;
        return 0;
      };
      const isLeftAssoc = () => true;

      for (const t of tokens) {
        if (t.type === 'num') { output.push(t); continue; }
        const op = t.value;

        if (op === '(') { ops.push(op); continue; }
        if (op === ')') {
          while (ops.length && ops[ops.length - 1] !== '(') {
            output.push({ type: 'op', value: ops.pop() });
          }
          if (!ops.length) throw new Error("Mismatched )");
          ops.pop();
          continue;
        }

        while (ops.length) {
          const top = ops[ops.length - 1];
          if (top === '(') break;
          const p1 = precedence(op);
          const p2 = precedence(top);
          if ((isLeftAssoc(op) && p1 <= p2)) output.push({ type: 'op', value: ops.pop() });
          else break;
        }
        ops.push(op);
      }

      while (ops.length) {
        const top = ops.pop();
        if (top === '(' || top === ')') throw new Error("Mismatched ()");
        output.push({ type: 'op', value: top });
      }
      return output;
    }

    function evalRPN(rpn) {
      const stack = [];
      for (const t of rpn) {
        if (t.type === 'num') { stack.push(t.value); continue; }
        const op = t.value;

        if (op === '%') {
          if (stack.length < 1) throw new Error("Bad %");
          const a = stack.pop();
          stack.push(a / 100);
          continue;
        }

        if (stack.length < 2) throw new Error("Bad op");
        const b = stack.pop();
        const a = stack.pop();

        if (op === '+') stack.push(a + b);
        else if (op === '-') stack.push(a - b);
        else if (op === '*') stack.push(a * b);
        else if (op === '/') stack.push(a / b);
        else throw new Error("Unknown op");
      }
      if (stack.length !== 1) throw new Error("Bad expr");
      return stack[0];
    }

    // =========================
    // Mini calculator history
    // =========================
    function loadCalcHistory() {
      return JSON.parse(localStorage.getItem(CALC_HISTORY_KEY)) || [];
    }

    function saveCalcHistoryStore(arr) {
      localStorage.setItem(CALC_HISTORY_KEY, JSON.stringify(arr));
    }

    function saveCalcHistory(expr, result) {
      const e = (expr || "").trim();
      if (!e) return;
      if (result === "Error") return;

      const history = loadCalcHistory();
      const entry = { ts: Date.now(), expr: e, res: String(result) };

      if (history.length > 0 && history[0].expr === entry.expr && history[0].res === entry.res) return;

      history.unshift(entry);
      saveCalcHistoryStore(history.slice(0, CALC_HISTORY_MAX));
    }

    function clearCalcHistory() {
      localStorage.removeItem(CALC_HISTORY_KEY);
      renderCalcHistory();
    }

    function renderCalcHistory() {
      const list = document.getElementById('calcHistoryList');
      const history = loadCalcHistory();
      list.innerHTML = "";

      if (!history.length) {
        const empty = document.createElement('div');
        empty.style.fontSize = "0.74rem";
        empty.style.color = "var(--text-secondary)";
        empty.style.fontWeight = "850";
        empty.style.padding = "6px 2px";
        empty.innerText = "暂无记录（按 = 后自动保存）";
        list.appendChild(empty);
        return;
      }

      for (const h of history) {
        const item = document.createElement('div');
        item.className = 'calc-h-item';

        const left = document.createElement('div');
        left.className = 'calc-h-expr math';
        left.innerText = h.expr;

        const right = document.createElement('div');
        right.className = 'calc-h-res math';
        right.innerText = "= " + h.res;

        item.appendChild(left);
        item.appendChild(right);

        item.onclick = () => {
          calcExpression = h.expr;
          const v = Number(h.res);
          calcLastResult = isFinite(v) ? normalizeNumber(v) : h.res;
          updateCalcDisplay();
        };

        list.appendChild(item);
      }
    }

    // =========================
    // Weather module (QWeather)
    // =========================
    function setWeatherStatus(text, color = "#86868b") {
      const el = document.getElementById('weatherStatus');
      el.innerText = text;
      el.style.color = color;
    }

    function setCityBadge(cityId, text, color = "#0a3d91", bg = "rgba(0,113,227,0.10)", bd = "rgba(0,113,227,0.18)") {
      const el = document.getElementById(`${cityId}_badge`);
      if (!el) return;
      el.innerText = text;
      el.style.color = color;
      el.style.background = bg;
      el.style.borderColor = bd;
    }

    function safeNum(v, fallback = null) {
      const n = Number(v);
      return isFinite(n) ? n : fallback;
    }

    function hhmmFromISO(isoString) {
      if (!isoString) return "--:--";
      const t = isoString.split('T')[1] || "";
      if (!t) return "--:--";
      const hh = t.slice(0,2);
      const mm = t.slice(3,5);
      if (hh && mm) return `${hh}:${mm}`;
      return "--:--";
    }

    function iconEmojiFromQWCode(codeStr) {
      const c = parseInt(codeStr, 10);
      if (!isFinite(c)) return "⛅";
      if (c === 100) return "☀️";
      if (c >= 101 && c <= 103) return "⛅";
      if (c === 104) return "☁️";
      if (c >= 300 && c <= 399) return "🌧️";
      if (c >= 200 && c <= 213) return "⛈️";
      if (c >= 400 && c <= 499) return "❄️";
      if (c >= 500 && c <= 599) return "🌫️";
      if (c >= 600 && c <= 699) return "🌪️";
      if (c >= 700 && c <= 799) return "🌫️";
      if (c >= 800) return "🌙";
      return "⛅";
    }

    function setCityPlaceholder(cityId) {
      document.getElementById(`${cityId}_update`).innerText = "更新时间：--:--";
      document.getElementById(`${cityId}_icon`).innerText = "—";
      document.getElementById(`${cityId}_temp`).innerText = "--";
      document.getElementById(`${cityId}_text`).innerText = "--";
      document.getElementById(`${cityId}_hilo`).innerText = "最高/最低：-- / -- °C";
      document.getElementById(`${cityId}_hum`).innerText = "--%";
      document.getElementById(`${cityId}_wind`).innerText = "-- m/s";
      for (let i = 1; i <= 3; i++) {
        document.getElementById(`${cityId}_d${i}_icon`).innerText = "—";
        document.getElementById(`${cityId}_d${i}_temp`).innerText = "-- / -- °C";
      }
    }

    function loadWeatherStore() {
      return JSON.parse(localStorage.getItem(WEATHER_CACHE_KEY)) || {
        lastFetchTs: 0,
        cache: {},
        geo: {}
      };
    }

    function saveWeatherStore(store) {
      localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify(store));
    }

    function loadWeatherLimiter() {
      const todayStr = new Date().toDateString();
      let lim = JSON.parse(localStorage.getItem(WEATHER_LIMIT_KEY)) || { date: '', count: 0 };
      if (lim.date !== todayStr) {
        lim = { date: todayStr, count: 0 };
        localStorage.setItem(WEATHER_LIMIT_KEY, JSON.stringify(lim));
      }
      return lim;
    }

    function saveWeatherLimiter(lim) {
      localStorage.setItem(WEATHER_LIMIT_KEY, JSON.stringify(lim));
    }

    function shouldUseWeatherCache(store) {
      const now = Date.now();
      const minMs = WEATHER_MIN_REFRESH_MINUTES * 60 * 1000;
      return (now - (store.lastFetchTs || 0)) < minMs;
    }

    async function qwFetchJson(path, paramsObj) {
      const params = new URLSearchParams(paramsObj || {});
      params.set('key', QW_API_KEY);
      const url = `https://${QW_API_HOST}${path}?${params.toString()}`;
      const res = await fetch(url, { method: 'GET' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    async function geocodePlace(place, store) {
      const geoKey = `${place.location}|${place.adm}`;
      if (store.geo && store.geo[geoKey] && store.geo[geoKey].locationId) {
        return store.geo[geoKey];
      }

      const data = await qwFetchJson('/geo/v2/city/lookup', {
        location: place.location,
        adm: place.adm,
        range: place.range || 'cn',
        number: '1',
        lang: 'zh'
      });

      if (String(data.code) !== "200" || !data.location || !data.location.length) {
        throw new Error(`Geo failed code=${data.code}`);
      }

      const loc = data.location[0];
      const geo = {
        locationId: loc.id,
        name: loc.name || place.displayName,
        adm1: loc.adm1 || '',
        adm2: loc.adm2 || '',
        adm3: loc.adm3 || ''
      };

      store.geo = store.geo || {};
      store.geo[geoKey] = geo;
      saveWeatherStore(store);
      return geo;
    }

    async function fetchPlaceWeather(place, store) {
      const geo = await geocodePlace(place, store);

      const [nowData, dailyData] = await Promise.all([
        qwFetchJson('/v7/weather/now', { location: geo.locationId, lang: 'zh', unit: 'm' }),
        qwFetchJson('/v7/weather/7d',  { location: geo.locationId, lang: 'zh', unit: 'm' })
      ]);

      if (String(nowData.code) !== "200" || !nowData.now) {
        throw new Error(`Now failed code=${nowData.code}`);
      }
      if (String(dailyData.code) !== "200" || !dailyData.daily || dailyData.daily.length < 4) {
        throw new Error(`7d failed code=${dailyData.code}`);
      }

      return {
        placeId: place.id,
        displayName: place.displayName,
        geoName: geo.name,
        now: nowData.now,
        nowUpdateTime: nowData.updateTime,
        daily: dailyData.daily,
        dailyUpdateTime: dailyData.updateTime
      };
    }

    function renderPlaceWeather(placeId, payload) {
      const t = hhmmFromISO(payload.nowUpdateTime) || hhmmFromISO(payload.dailyUpdateTime);
      document.getElementById(`${placeId}_update`).innerText = `更新时间：${t}`;

      const now = payload.now;
      const daily0 = payload.daily[0];

      const temp = safeNum(now.temp, null);
      const hum = safeNum(now.humidity, null);
      const wind = safeNum(now.windSpeed, null);

      document.getElementById(`${placeId}_icon`).innerText = iconEmojiFromQWCode(now.icon);
      document.getElementById(`${placeId}_temp`).innerText = (temp === null ? "--" : String(Math.round(temp)));
      document.getElementById(`${placeId}_text`).innerText = now.text || "--";
      document.getElementById(`${placeId}_hilo`).innerText = `最高/最低：${daily0.tempMax ?? "--"} / ${daily0.tempMin ?? "--"} °C`;
      document.getElementById(`${placeId}_hum`).innerText = (hum === null ? "--%" : `${hum}%`);
      document.getElementById(`${placeId}_wind`).innerText = (wind === null ? "-- m/s" : `${wind} m/s`);

      const labels = ["明天", "后天", "大后天"];
      for (let i = 1; i <= 3; i++) {
        const d = payload.daily[i];
        document.getElementById(`${placeId}_d${i}_label`).innerText = labels[i-1];
        document.getElementById(`${placeId}_d${i}_icon`).innerText = iconEmojiFromQWCode(d.iconDay || d.iconNight);
        document.getElementById(`${placeId}_d${i}_temp`).innerText = `${d.tempMax ?? "--"} / ${d.tempMin ?? "--"} °C`;
      }

      setCityBadge(placeId, "已更新", "#1f6d3b", "rgba(52,199,89,0.12)", "rgba(52,199,89,0.20)");
    }

    function renderFromWeatherCache(store) {
      const cache = store.cache || {};
      let renderedAny = false;

      for (const p of WEATHER_PLACES) {
        if (cache[p.id]) {
          renderPlaceWeather(p.id, cache[p.id]);
          renderedAny = true;
        } else {
          setCityPlaceholder(p.id);
          setCityBadge(p.id, "无缓存", "#6b5b00", "rgba(255,159,10,0.12)", "rgba(255,159,10,0.22)");
        }
      }

      if (renderedAny) {
        const dt = store.lastFetchTs ? new Date(store.lastFetchTs) : null;
        const hh = dt ? dt.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false }) : "--:--";
        setWeatherStatus(`使用缓存（上次：${hh}）`, "#ff9f0a");
      } else {
        setWeatherStatus("暂无缓存可用", "#ff3b30");
      }
    }

    async function initWeather() {
      for (const p of WEATHER_PLACES) setCityPlaceholder(p.id);
      setWeatherStatus("正在获取天气...", "#0071e3");

      const store = loadWeatherStore();
      const limiter = loadWeatherLimiter();

      if (shouldUseWeatherCache(store)) {
        renderFromWeatherCache(store);
        return;
      }

      if (limiter.count >= WEATHER_MAX_CALLS_PER_DAY) {
        renderFromWeatherCache(store);
        setWeatherStatus(`已达今日上限（${WEATHER_MAX_CALLS_PER_DAY}次），使用缓存`, "#86868b");
        for (const p of WEATHER_PLACES) setCityBadge(p.id, "今日上限", "#666", "rgba(134,134,139,0.16)", "rgba(134,134,139,0.25)");
        return;
      }

      try {
        for (const p of WEATHER_PLACES) setCityBadge(p.id, "更新中...", "#0a3d91", "rgba(0,113,227,0.10)", "rgba(0,113,227,0.18)");

        const results = await Promise.all(WEATHER_PLACES.map(p => fetchPlaceWeather(p, store)));

        store.cache = store.cache || {};
        for (const r of results) store.cache[r.placeId] = r;
        store.lastFetchTs = Date.now();
        saveWeatherStore(store);

        limiter.count += 1;
        saveWeatherLimiter(limiter);

        for (const r of results) renderPlaceWeather(r.placeId, r);

        setWeatherStatus(`已更新（今日第${limiter.count}次）`, "#34c759");
      } catch (err) {
        console.error(err);
        renderFromWeatherCache(store);
        setWeatherStatus("更新失败，使用缓存", "#ff3b30");
        for (const p of WEATHER_PLACES) setCityBadge(p.id, "更新失败", "#b00020", "rgba(255,59,48,0.10)", "rgba(255,59,48,0.20)");
      }
    }
  </script>
  <script>
    (function () {
      const wmFileInput = document.getElementById('wmFileInput');
      const wmTargetKbInput = document.getElementById('wmTargetKb');
      const wmDownloadNameInput = document.getElementById('wmDownloadName');
      const wmRunBtn = document.getElementById('wmRunBtn');

      if (!wmFileInput || !wmTargetKbInput || !wmDownloadNameInput || !wmRunBtn) {
        return;
      }

      const WM_BG_48_DATA_URL = 'data:image/png;base64,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';
      const WM_BG_96_DATA_URL = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAIAAABt+uBvAAAfrElEQVR4nJV9zXNc15Xf75zXIuBUjG45M7GyEahFTMhVMUEvhmQqGYJeRPTG1mokbUL5v5rsaM/CkjdDr4b2RqCnKga9iIHJwqCyMCgvbG/ibparBGjwzpnF+bjnvm7Q9isU2Hj93r3nno/f+bgfJOaZqg4EJfglSkSXMtLAKkRETKqqRMM4jmC1Z5hZVZEXEylUiYgAISKBf8sgiKoqDayqIkJEKBeRArh9++7BwcHn558/+8XRz//30cDDOI7WCxGBCYCIZL9EpKoKEKCqzFzpr09aCzZAb628DjAAggBin5UEBCPfuxcRiIpIG2+On8TuZ9Ot9eg+Pxt9+TkIIDBZL9lU/yLv7Czeeeedra2txWLxzv948KXtL9WxGWuS1HzRvlKAFDpKtm8yGMfRPmc7diVtRcA+8GEYGqMBEDEgIpcABKqkSiIMgYoIKQjCIACqojpmQ+v8IrUuRyVJ9pk2qY7Gpon0AIAAJoG+8Z/eaGQp9vb2UloCFRWI6igQJQWEmGbeCBGI7DMpjFpmBhPPBh/zbAATRCEKZSgn2UzEpGyM1iZCKEhBopzq54IiqGqaWw5VtXAkBl9V3dlUpG2iMD7Yncpcex7eIO/tfb3IDbu7u9kaFTv2Xpi1kMUAmJi5ERDWnZprJm/jomCohjJOlAsFATjJVcIwzFgZzNmKqIg29VNVIiW2RkLD1fGo2hoRQYhBAInAmBW/Z0SD9y9KCmJ9663dVB8o3n77bSJ7HUQ08EBEzMxGFyuxjyqErwLDt1FDpUzfBU6n2w6JYnRlrCCljpXMDFUEv9jZFhDoRAYo8jDwMBiVYcwAYI0Y7xuOAvW3KS0zM7NB5jAMwdPR/jSx77755ny+qGqytbV1/fr11Oscnph+a1PDqphErjnGqqp0eYfKlc1mIz4WdStxDWJms8+0IITdyeWoY2sXgHFalQBiEClctswOBETqPlEASXAdxzGG5L7JsA/A/q1bQDEkAoAbN27kDbN6/1FVHSFjNyS3LKLmW1nVbd9NHsRwxBCoYaKqmpyUREl65IYzKDmaVo1iO0aEccHeGUdXnIo4CB+cdpfmrfHA5eVlEXvzdNd3dxtF4V/39/cFKujIJSIaWMmdReqFjGO2ZpaCUGRXc1COvIIOhbNL3acCQDb2Es5YtIIBI3SUgZw7Ah1VBKpQmH0RlCAQ81noVd16UnKMpOBa93twRbvx9t5ivnC1MQ4Rwaxsd7eyu36wUQzkxDMxmd9Rl6uxyaU+du6/sEBERkMrUmSgY97DyGN7pwlc4UqUuq1q0Cgi6LlrHtY0yNQnv5qMZ/23iHexf/OmhXr5ajZycHC/oklqsT1BAYK1lxy/RtCUNphW0uDCZUdJP3UBCgAwmEYVoiEBmyBEauFJ0w4JnGdWSvCHJHK5TimY3BW5hUqNnoxpNkYiWuzM927sdWakjUfXd3cX83mMzBVcRaAGgo0wOA5YvGZdiMjo5sZEA4NLMK2SKAZpumZDViWMgBjgFoHXq0p7YpberAgA5iC0iMgF7r4fKX/nZDSmqvfu3attrne0f+tWCsmxdhhSlao/yp5SkZkpoj6dtN/rshANptFVfZgtsHAJSKYmREqkDNWxSYM5GjWvpIAoGIJIgkR1lPBrEQCqQiwzM91G+ACGYLHz+q39W5UlTkC5c/f2nWvXrjnQBLKk3WlkdqRQESIGKPwdjxp4Fw4XmaVYKKUQqKE+GEqw4COIIZHwYqkpqtpsLeJOs50ItFpgYoJJL1Dl74lEoobLChbqARiGYX9/XzHV3OzU/tza2rp7925VE44rlcJlTi2VqcplXWeQMfVTmg63Cak+UIIXVQXzbHAzjywnHhsQTtSkoapE3GJiu6Tpp/VYs1PjkcHBl+c7+/v7BKoaQ2SOCCDNb27fuX1t65qJmgYWBIIw0eDphRJM8lr426ROMABSQs3FwAB5EDMMM+ZZlXc+gprFQDnMm2salYFGdQEosU+2aFmuMdX+ybdM8kb3/YP788WihUONJiViTVgnbG9/6c7du0Q0ljCKIoJvFBY3VEU2USuQELdMkJhNhKZiGmlTY5CZTyZyImLGLlBNpRUikKmRB2/mHUM7Mj50iYWXcUMI6YmKBX47Ozs3b36jKg4oYgKFNUupWap3bt+Z7+xYDigiSiygcRyppNkM0lHM1ZICMjJUVCz4NtlbVcfZqgohHaEQwUgtlyoYJ9KKT6lKIpLp/LpbMV3wBKIm0OKZoaq/raOM/3qJgkQUEj44OLCRh4ynvjLU2f/c3tp68OBBakcx2FYkMDmJiNmIB3PULjT1j7ciQKnxXQ2UeBgYUHMzAEQvFSNYlYQwQFrEGVA1dE2IQERMAgMEYjCRDzPPKmX2+e0be/vfuBkKktgIoqaGwbMmmL29vTff3I1xewUqC0Cq5nOK6TFqrquqyqoOUi11hPnZsUV8FLHiQAxRRoG0asNExMNg+XdVv57TbQAWR4hLz6Dh0kJEVU0LB/BO6MJEObuakY2td3Hvfvfd7e1t6omMyAUAtBaOyxUm1hHfY5NbwBClC2Sg51qmYJANzx2JjtAxogZk7uspj3PNQx6DYCJmmmkEqESkKqZlKfaDeweL+VxrvFwGktwBoAnU4c4W88X9gwNS8TqBR+3+UGW4KQcR7GGyorcIhyKnETAzgxkDqZKKoZiqZNbUkm/K8K5wfRIUVAiotfcUiKpSqwB6Vqnq6PPVr3713r17zfLXL+rvR9ICdSC/ffvO7u51J52b+mdklLDNnNoRH/q6lUZoHmQjm2UmzUpGhElehIZ0fHE8F4XoQDOGFRXJ80e28iKrEmGQEYl/RMqzGZhFHC/mX955/72/s8jMR7+RR21U8bV9DA159913t7f/HdEAZVI2s4o40Avno14Gs9j9aY1CGth7nsjMEX+LYIQQKUcVqahAKkhyN0EhYajoUfMpLWpwf+/Ba7mDg4OD+c7CzCgUr5MwjCkGF9IqCl0pjTBfLL77ne8YiQ0uu8C6hdfVRWRMv24Wlo4F9Gg+Q0RliqMRMdjT1fWYfKxCmDcBj1kAWADmwAYmZfMCYFXC3x7cu7l/s3aSvxQgTutWr5umi4sPYWoAsHdj787f3CZS1bFiykAzCBGxjKo0jIFKqqPIZdR61GZZmBkggM39JdYyD9mmiLAqVDDhKFFXh88Xwr6iqoQWQVRWpg4CgOj169cP7h1URdCsKJKDVGOcexxMwoCJur3zzjtvvvlmEWpTZx3B/BplfBQSjVG0cC+RyzNEbSqGzPtIiSnQziom7AVgcJ+2mYoSaPAqTxbx3PGJVtS3Mtt8/vr7f/felWijUFFMHFpGiRWzC2Db9f7777/++rwW5y/FFEqho1uHKBMDnGhrHj39jE8ujqqqIMdsq4VZENfGU6UBQGS0e7XMXJ9J866/VTNphkB3dnYePny4tbVV360aMf1btUEzrX3f5+vb29sPH364mM9TZw1rndpWq3HK1wsAOQoeuijRO7Q2lUSQDlut7mPqbNZYp5KJyGZfqjVx5Htl1ghgnr8+//B7Hy4WiylrvK3yO3lAoLCyyENexdT54vXvffi9+Zd3krzWPCmjhoJUw+6cNVNVUlYlJcEwad7wNN8n8vpGIr/VSqg9AAf5Rk1KI8DbMkVsb29/+DC4c7U77741gK55WSIRNXY2ZbTocbH44IMPtra2mNnTV3fBha/FRyNYv0mp1+4ARAOriAXDSqIK5kEtrFQwD5k0O/sJsNS5xARtxYUCTPPXd95/7/2v/sc3oo/SNSHgxP5qk/QETy+d1sI4f4DQyiB5RwFguVz94B9+sFwumVkuPd2hCBpVRxXYDGiUotlm7pQ8MRAoiAY0F6SjqcXANjBVtaUtEQwrs8fvlgTGMwT48pc6Z5D8ev311x9++HA+n1OIpDGIHEpy6M6g6uJTa6x8BlKrqCO8WyffxrXVavXo0aPVapVZVap/zBrYSNtnJWmCV62fAZByA+nIGxiIUiBskYy7ZGtLCb5GoiS3KOoa3FkAJXGpHrrVEBUTPbcgsY83jF+K9dpspmz+13w+//Dhhzs7O4YGCYh1MqrhdLzV1i6VycUasvgaEcN80ybEjBUNHDBkDnxQ7bhjgsolI2+99dZ77723tbUVaw7Mhf8lFxUdydBR+/trPKJ4CsD5+fnHH398dnZm34dTK1ojwp57kJJHaomzFafYqoLD7Jqqyviv5iOTQV3oSMX02yxeV/S8fef2tx98GxvB7y+6NvJigkf9Y+Ytar+Hh4eHP3uao1ARtnRd1Tz1RschyGURREQDzVSViGeqHllVDVJV046CTVZAaBUr++e1115799139/b2/oIB/5nf+3dmlpFuxFfUMwW9ChyfHB8+fbparXzsANEACKACxxq7HD3JEk57nckKzRRrEOr0rk+o2qPsXPeyb/gvr5Ardnd3v/Pud82dV/q6QeJP8GjKkfyNeHddg9Y4st77arX64ccf/f73v4cID1CBxMIdtizMWSMI7xzYxMmBzFAasqShWdBd4uP2GoBr167dPzi4fefOnzvsyajSneczsAC8Wk7vuSjuqm7UoI3COPzZ039+eig2HUDwWg+8dgxEEkIWqDqDEJ6deDYQKcTr8LGMzCbsWwJBRKphVord3d3vfue788V8M3HNbVOSEXyJxyYMqhxZG2TXxeSP3g9ufHH1cvlPT56cnp5G+JmFSDe9EqmIGVchakDeyuds2seZyTyOl4AHkPOdnQcPvr1344ZFfH0E6ExxRhRV8BrN1CG194nR0qwW9BbDqdwpZjjVIwoaqvYRYKj0yeHy5UvYmuVSFOw6goeOnq/Nrr3WKo9j1ZqWyAhGAFuvbd+9e/f2ndvb29ubHA2Zs82eJpy6Mthr/KXmrjc/ENyZ3J+E6Y2hrsDEbfAnJ8efHD5dLpdMM1UFCW2EToB8RqPN0rj9ZyUo37y2de3u3Tt3bt/1GOcV+l+tqR+AM+iqd5uou/rQn8GgK9halcsTDn9/uVwdnxwf//JfVqsVD6gFE9iyX26RdHPtlkZYSgHAErSdxfyb3/zm7dt/s7W1vWlkV4/zFWpy1firt9qoTVfx6CpyOvPsX1aAcHJ8cnh4uFqtmFnkkpkrr+CxDDvuGu6kHu2++ebBwf3d67vxKLDuNeqw1z3OVfHeK4Zn6sCEUcG2WGYtpvuL4tA1oytNOGT/6lenJycnn356CkDEc4OEFwJ7+AdAFbu71/f29m7d2u9UpoYnVw3sFXrRkRufuupUfEFrjVwdBF3ZC2LsiKrAelSl3TvM/Ic//OHs7Ozk5P+enZ3lYigzMWxtbb99Y+/69et7e3tXmhKV1oMEb4XNvF2DpgBUjSX5EP62Mah5/U2hzSsYtNFsJ8C0Rnx8pUmMmkmKrlarFy/Onj9//tvf/na5XNKd/3rnwTsPGgUdCnh+0cF87SZ1ta2gaBR2JE/AuwsCE8ZfwQWahpT55JW2TNMQqQ6qNexfhKQ6Mf/0pz/lO7dbKFwmgaxbLVyaEFy7105lJhFyzyqvJKxHwGVSrNKdXXR8mejZ5FnP4LXeL2sl2jYDiqmaYE0Tvjnxe/fuzba3m02VMnCIND53I6qmUc1nSjQBWise6WiNYi39IZEh6JtyhLLmuHZV9TRnIvF6amqngGZPhgzkAiZE+wbJpIrPzy/48OnTJpM1BEAKk6b369gmH6+6GXpBU4doItA11KgtaNPojV2o1yK5GW8PfOtXgE+17q7jo6NnRAN/5Stf+ev/8Fdf//rXd3enm0omUeYr/Nhffl0BORT68oqoEuXVDS5s7ZWNnNoI4UrnFxfPT391dnZ2enp6cXER6yBdD8fd3es3b+6/9dZb8/l8I+VY49qfc00z1Y6u9ac3RxUdmmn/cG1yveUJg7Sgftw8Pz8/Pjk+PX3+4uw3sdRHPZImanXZTMG+duNrt27t3/jaXhJxZbmno6/knzUXWwvSYClSK25c4Yw6gIdepcSb4G/DY5PnCQDOzl4cPj08++zXICLL46XlsV6Trjuw/GJV1fmXF/fv379586bfs2nDnBhZj32ok0/mX5EuUoQejJgNmPJi3aP/ycG/ysSom0FC082Li4ufPzs6OTlZLpeAwFKuEcaNnA0lWxgdjQ0gYZBqrIwQArCzmO/v79+6ub9YLCpTYOFPDuwqkitY2AjDH13hl4IxtBbLKCZhgze6ITQl0HqmQoCen58/Ozo6Ojq6uDi3u5ZmCSmJTe359AQREc+GtqJFGSQQJfKikk2ejSrMvPPvv3z//v2b+zfTrVYoVcvjwoF0SlyVCx3FmxiU4fb6yHsG1cFr90wPN63li4vznx/9/Ojo6PKLL2SSmDIJKSuRwnbrkA9zKLPPZWrQ9gXaQit7wOrQO/Odb33rW9/4L9+oGjSpARGzqnS2UEOVdW5sMCKsffEnUKWZ/BXX6enzJz958vLlS1X1FQheWeS0GFtCZ3X3WIo5+KKY5stiupaI6opMz3GZANz4z1978ODBYrFoeUKfgmX9xW+/gkEbsXnCkbU7V3iM4v+K7qxWy398/Pizz36TrwwE9X3ABoheurcimRtXaJBnEiWf4GSQ1Wvd58XmGYQ23bt3r+1n2ui101w2lUr6Ofu+KDEpg1IkhH0jU/ZuigmPnh09fXp4fn6eKzU2XsoKUQjIdkBlyZVn4c/iVkxoxzrNXL9xOdb5eHvrjTfe+OCDDyp4b2SQm6F/bgtLu2pHA/5N0L0mgA0S6Rm0XC4f//jxixdnceNKBhGR2L567eaWYRoEoJ/0aK95Md+wRpQAHmw7kACggSG6WCwODg5u7u9vcM9XaRCF9+3jvaicYN15rcfWVzDIGz09ff74x48vLi4A9FseNzNLWZNB1KHqAIqDSMLq6mDK/pmOr6Q2ly+qqsMw/Le//e8H9w4azYRalNow9+AimUxaxCsVa9KR2/Kq0Pe4vcYz4MmTJ89+8YtCrU4MPKew2h0SU6QEk4yk850oWnmtk0EEjHmmi/VRS/q5CMaM8vr16++/957PeRBitdhVCzNcI7qAux+nZ4/UsQxTEXZQdH5+/tGPPn7x4oWq5GxwQQ+NhWXJoDjxhe2Ui6G0HBPWRCTSlpo7BCkTs+olgG4e0rkZGsfJaVLVxWLx8H8+XMznyEmFcCydEoW+ELKy8cqSGLCBy0hccxnYEqHly1UObxPuCMfydj91Bc2LDTSrs/CqI2EGYFMtmOx+S2VhSUZZ4u9QLQS2A1QEwM7O3BffrYWF6YIzBdkQ2uGK53WNWzViUl2ulo++/2i5XKLUQNOOTIQiYqbEakstxRb2JINIbXkU5wrGXGmPbAgZJdcVMOl3y0Ly/M3lWJ9VEkrTMJ84Qu0WW1MutfBV7dO3+ue7y5RTAf3d73//6PuPVqsl+c4aSiKnjdTRZgUvky3/t+zUj09TmjBFNcc5W31suyL8RCHKw3B8N81yufz7//X3v/vd79aGWWq36zqbVW2DHu0fs5ps7GktjdByufqHH/zgjy//qLEsNVdC2+4dKqXV2oCtb23jL1LPq+UZlUrPRAqDc7N0ZVY04SqtfpKJEuHi4vyjH320XC2nbGj+qTXXfdW7+ahBxsq9CMqT0cvl8tH3H33++YWI5BkYuTbQ9rvVrQGq+SFsIltTtYAmFwnDViSWJasEMCnn+o/c/7O+oc46U4UgVGno9GK1XD569Gi5XPYimVgdHGK1vFt4qCV8d0ii6JuwXK3MnAVj2TuWg9dRR49gYhE086BKNVMloE1Lw/fca9jWZJ10YAqocrrpZ2RYkQAUi7EZ2u78L1qtlo8ePfr88/PKlLoDeO3qgc9/ty4pC+SE8/PzR99/9PLly/SheS5FwWYQkc2419XubaRxpd1pH0O0fQwASGEnvqgqg9HtAnEzti0yOQoiUoIyUZyhkZdt0lwtlx9/9BEZpqjz28ZNayq5XpmncFXFLJxzH/3wRy9Xf6y8HmjI0AwA0WDrEicupfQ2ilzqeGknGZF6WFwpKkd0qdoJQxOZNlQKh1/QqY1wcpiGxoJGIrx4cfbkyZP1Nifkls/Ni657Hvv+8PDwsxcv1llsM+vWRJtij73y651edeUzTCozbh5RMAqUZ4PtpFcdY3NGxKDEqcLKUKaBZmzbHdqPeZA2tl8cPXt+ejrhjmqBmG5uVpsfy3XVoYBQHP/yl08PnyLO74PFYoCq2lqvcpnDFekPb/SKDw2qJJ1c/SQT1VFVBlsK3JxixIe2/WCC9iJQ6jCrEqL98QLsx9IN7tmZ/vHx4+VyOZGSa3QN+Vro539NnOZqtfrZz35GsRLOVDt3E0a/1K3QoC4di3NrbPd4t0esrSVXEEFE2OM7AdFA4ExG1NYMeZ1ogLRtjxZIqCorsfp+USJqG/YNgFiVxM4bEugXX3zx+PHjwh7TIMkAoxO8OlxXL2aG98OPP1q+XNnhlVHbU8VIZPu8eojlmalJ4qwL2z2vY/BAea7MyGz5w8DMEWUrQCSxtb1qR9TSNFfJUnDHuCCSu+3HtSCgk7wSPvvss2fPnrW/C+iU9xqUhsdsPvjw6WGNP3PxYI58EkOPl7a6su2P7i9XpWyHSlo7jgrf9MJ22EoXCnpQBLYzUbrWc9QM2DlDMqqVckQYHnl5A/aGuK89PDy06JGyJOQA07kYNbCpnRKtVsunh/88EA/E0QsZPtr+2BybBXuqo51t1vsZCtJtpKNvs40f5pkveGYCD75OkcrG4Xq5JKk75mEiCe9U1SBIPaPoQIqIbLnkxcXF4x//GBQ1HXRtBkpXvrTf//Tkie10HscxZ2JUDZvrTrHkVAviaqSS4p1koFouS/dlHNk2/ChBMJop+k876ETJjpKFxQm2J3qwmDsxi5RFkpUAQCqx9wgqlyFJefHrs+enzwGN0zO7ALlX0XYdnxx/+umnNEQXwyw5q6o0wE5wycsLOHYOCakhDhHleYl+PlnQ7D9gUX/G9rt2WpMMrla9LoHq3aoEXC6bAmWeDRqbEYnoyZMn5+clvHY3EcoySU0IAA4/+aSBURwYpKWGV0liP/CttNLTHF4vM7/UJQGVPd0A2zG/REqkdi6inT4QN4nIj5AzjTBtyvOk1eq4QhAdiAEWOy3DXBwx+dFhY+44U8Ly5erZs6OOhZG71KSMfFETjk9OVqs/QuPssHIsj/q2d/LN3d6bbXGiyBNINY7osfMa1N8gZtsCh/YT3AQrnNNpqE2iVV9SPnX/Uy1RZ0K/rlP+LkesF/WaOvNL7Jm69vhj7S2Xq6dPn5psiwV1dfjCL53NZgapWYGwr7rTZXoie4WX2jjXpzUOJwzAUyUZ9dJ0x2S1TpOI5L4FirMw86AuWPBZKl7G988vzn9+dGQG1ZG9hkLHx79cLv+/siprFKFaO86XEYhzPBKnS17aVMPxxVro9mQ0r+L+SkeCdBhERDU7GwbWmKrLYwZrpBCPDQlSE1fIE9nUkA84enbUIdHkCh6d/Mux1vSvBPf5mW2XUwQ1Odqr9LoqeK24Z+SVLbTxiHSFIiWMowBkx1dmKXNUyd0L1p4hgB/22icc4eDayKwr1ZGBL87PjwyJJl6rGNrxyfFqtWImUmYvALIhZh9JiOrY7acFkba9uDl7wxgMNEnZbFbgAbMQyI9pkIx789gYSz1aME7M5Afx+AL9DZYfR12lrDJCSe5svPKb4+NjoAt2Jn8eHh5WfcmcK1WDqK3+Sl02SiZHLayTRJlzAwrGpm85lMrYDFX4nP5ovPAT4jTP/kIjCAZAZZ6kqnRV2u6ID3CcKc4vly9fnL3oyon+Mgg4PT19+XIVMS6SNZE65MYJrsgdWqyqY0bYSR5EGWTxkZNqft1nt9rJs65B9kdh9rQqmNdEbtXOq21TXwN2ppe0oz4J4JNPPuk1p0XVx8fH6TRblWf0//7AQJB51o7RXkvNxnL8Y3XKG7V7ctOMI3IQ0ZhBHcAzRVffWX/Z74jmUXTrWFjY5xFtHMLWziFSwovffHZ+cR4ZmbMGhOVydfr/Ts1DEClIBaPIZZFfqFU4xzykzjggInZOq/HOUQk6qV4nUJLC4MlwygWAUB8ugOLlPO6CgGwxFSo9yEQyhcrW/bpw0iKOT46zn+AQXrx4kTcA+LKuiVeMRLQ5nYghM5LOqvNGEebYs5HJk8FysjMiRxHBCBKCHUQIAH7y+ERFs3UpR20nFjYbDIBnxH9+ArZKQtJ6evo8JZpx0Mnx/4Hk+fmceUGG4wz1gmHQlrGPqsLOktI4KiKQiJllHHWU/CFVHS8l0heL4DJA4RSy/VscZ5V2A51kSnLBGjUFro4jPgAS/jGqSxM3d3Z2dn5+UaeqV6vl2dlZfdi/KuR5Hk1NHimk6jqqXsOKpakvDg5O8ETq4cVKZEl21LglbDqa9O0ANCOl7vSdzWZZu0SEHhmJ+JKPPINXAIniKwXeNBPW0+e/qkHlr399FosuOs/o+Q3Zrv8WYRANFHBhg7RgbRgGK/INQwisnAOJQC6jqtkBtUUZXcmiqFLnsCYHu6U2orr52NTpZxFwpyP5n3mkVKuSEuHs12f1zumnz52zExQzhBRHfrMA0qYmteWkTbU7T7o9Foe4V12bqN5MR2Do4y772ghXVgiYRUfyVRCggWNWgDRiVq0g2tkp217+MtfsJ+ygDOn09LQG0L/77W+pLSrxBIIpAMGgnAReEgUgtovFqLLsUMNSfAkCQ3IFK1GS6px3LhtIj83iiHydXWVt8wHBzDijwqcE8j9eco+WI1ZLm6zM7RP2Whxfrzit34svzn/ykyfLPyzPz8+f/OTJ6uVLNLrF9qsbd2owXSWan6U73q47YXrioeqVEF4fBvBvwZvfB2giLLAAAAAASUVORK5CYII=';

      const ALPHA_THRESHOLD = 0.002;
      const MAX_ALPHA = 0.99;
      const LOGO_VALUE = 255;

      let wmSelectedFile = null;
      let wmSelectedObjectUrl = null;
      let wmResultObjectUrl = null;

      const wmAlphaMapCache = {};
      const wmBgImageCache = {};

      function wmMimeToExt(mime) {
        if (mime === 'image/jpeg') return 'jpg';
        if (mime === 'image/png') return 'png';
        return 'webp';
      }

      function wmGetDefaultDownloadName(fileName) {
        const base = (fileName || 'output').replace(/\.[^.]+$/, '');
        return `${base}_unwatermarked_compressed`;
      }

      function wmSanitizeDownloadName(name) {
        const trimmed = (name || '').trim();
        const noExt = trimmed.replace(/\.(png|jpe?g|webp|gif|bmp|avif)$/i, '');
        const cleaned = noExt
          .replace(/[<>:"/\\|?*\u0000-\u001f]/g, '_')
          .replace(/[. ]+$/g, '')
          .trim();
        return cleaned || 'output';
      }

      function wmLoadImage(src) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error('图片加载失败'));
          img.src = src;
        });
      }

      function detectWatermarkConfig(imageWidth, imageHeight) {
        if (imageWidth > 1024 && imageHeight > 1024) {
          return { logoSize: 96, marginRight: 64, marginBottom: 64 };
        }
        return { logoSize: 48, marginRight: 32, marginBottom: 32 };
      }

      function calculateWatermarkPosition(imageWidth, imageHeight, config) {
        const { logoSize, marginRight, marginBottom } = config;
        return {
          x: imageWidth - marginRight - logoSize,
          y: imageHeight - marginBottom - logoSize,
          width: logoSize,
          height: logoSize
        };
      }

      function calculateAlphaMap(bgCaptureImageData) {
        const { width, height, data } = bgCaptureImageData;
        const alphaMap = new Float32Array(width * height);

        for (let i = 0; i < alphaMap.length; i++) {
          const idx = i * 4;
          const r = data[idx];
          const g = data[idx + 1];
          const b = data[idx + 2];
          const maxChannel = Math.max(r, g, b);
          alphaMap[i] = maxChannel / 255.0;
        }

        return alphaMap;
      }

      async function ensureBgImages() {
        if (wmBgImageCache.bg48 && wmBgImageCache.bg96) return;
        const [bg48, bg96] = await Promise.all([
          wmLoadImage(WM_BG_48_DATA_URL),
          wmLoadImage(WM_BG_96_DATA_URL)
        ]);
        wmBgImageCache.bg48 = bg48;
        wmBgImageCache.bg96 = bg96;
      }

      async function getAlphaMap(size) {
        if (wmAlphaMapCache[size]) return wmAlphaMapCache[size];
        await ensureBgImages();

        const bgImage = size === 48 ? wmBgImageCache.bg48 : wmBgImageCache.bg96;
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        ctx.drawImage(bgImage, 0, 0, size, size);

        const imageData = ctx.getImageData(0, 0, size, size);
        const alphaMap = calculateAlphaMap(imageData);
        wmAlphaMapCache[size] = alphaMap;
        return alphaMap;
      }

      function removeWatermark(imageData, alphaMap, position) {
        const { x, y, width, height } = position;

        for (let row = 0; row < height; row++) {
          for (let col = 0; col < width; col++) {
            const imgIdx = ((y + row) * imageData.width + (x + col)) * 4;
            const alphaIdx = row * width + col;
            let alpha = alphaMap[alphaIdx];

            if (alpha < ALPHA_THRESHOLD) continue;

            alpha = Math.min(alpha, MAX_ALPHA);
            const oneMinusAlpha = 1.0 - alpha;

            for (let c = 0; c < 3; c++) {
              const watermarked = imageData.data[imgIdx + c];
              const original = (watermarked - alpha * LOGO_VALUE) / oneMinusAlpha;
              imageData.data[imgIdx + c] = Math.max(0, Math.min(255, Math.round(original)));
            }
          }
        }
      }

      function canvasToBlob(canvas, mimeType, quality) {
        return new Promise((resolve, reject) => {
          canvas.toBlob((blob) => {
            if (blob) resolve(blob);
            else reject(new Error('导出图片失败'));
          }, mimeType, quality);
        });
      }

      async function findBestQualityBlob(canvas, mimeType, targetBytes) {
        let low = 0.05;
        let high = 0.98;
        let best = null;

        for (let i = 0; i < 9; i++) {
          const q = (low + high) / 2;
          const blob = await canvasToBlob(canvas, mimeType, q);

          if (blob.size <= targetBytes) {
            best = { blob, quality: q, mimeType: blob.type || mimeType };
            low = q;
          } else {
            high = q;
          }
        }

        if (best) return best;
        const fallbackBlob = await canvasToBlob(canvas, mimeType, 0.05);
        return { blob: fallbackBlob, quality: 0.05, mimeType: fallbackBlob.type || mimeType };
      }

      function resizeCanvas(sourceCanvas, scale) {
        const out = document.createElement('canvas');
        out.width = Math.max(1, Math.round(sourceCanvas.width * scale));
        out.height = Math.max(1, Math.round(sourceCanvas.height * scale));
        const ctx = out.getContext('2d');
        ctx.drawImage(sourceCanvas, 0, 0, out.width, out.height);
        return out;
      }

      async function compressCanvas(inputCanvas, targetKb) {
        const targetBytes = Math.max(30, Math.floor(targetKb)) * 1024;
        let workingCanvas = inputCanvas;
        let bestResult = null;

        for (let round = 0; round < 6; round++) {
          const jpeg = await findBestQualityBlob(workingCanvas, 'image/jpeg', targetBytes);
          const chosen = jpeg;

          bestResult = {
            blob: chosen.blob,
            mimeType: chosen.mimeType,
            quality: chosen.quality,
            width: workingCanvas.width,
            height: workingCanvas.height
          };

          if (
            chosen.blob.size <= targetBytes ||
            workingCanvas.width < 320 ||
            workingCanvas.height < 320
          ) {
            return bestResult;
          }

          let scale = Math.sqrt(targetBytes / chosen.blob.size) * 0.96;
          if (!Number.isFinite(scale)) scale = 0.9;
          scale = Math.min(0.95, Math.max(0.55, scale));
          workingCanvas = resizeCanvas(workingCanvas, scale);
        }

        return bestResult;
      }

      async function runPipeline(imageUrl, targetKb) {
        const img = await wmLoadImage(imageUrl);
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth || img.width;
        canvas.height = img.naturalHeight || img.height;
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        ctx.drawImage(img, 0, 0);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const config = detectWatermarkConfig(canvas.width, canvas.height);
        const position = calculateWatermarkPosition(canvas.width, canvas.height, config);
        const alphaMap = await getAlphaMap(config.logoSize);

        removeWatermark(imageData, alphaMap, position);
        ctx.putImageData(imageData, 0, 0);

        const compressed = await compressCanvas(canvas, targetKb);
        return {
          blob: compressed.blob,
          mimeType: compressed.mimeType
        };
      }

      wmFileInput.addEventListener('change', () => {
        const file = wmFileInput.files && wmFileInput.files[0];
        wmSelectedFile = file || null;
        wmRunBtn.disabled = !wmSelectedFile;

        if (wmSelectedObjectUrl) {
          URL.revokeObjectURL(wmSelectedObjectUrl);
          wmSelectedObjectUrl = null;
        }

        if (!wmSelectedFile) {
          wmDownloadNameInput.value = '';
          return;
        }

        wmSelectedObjectUrl = URL.createObjectURL(wmSelectedFile);
        wmDownloadNameInput.value = wmGetDefaultDownloadName(wmSelectedFile.name);
      });

      wmRunBtn.addEventListener('click', async () => {
        if (!wmSelectedFile || !wmSelectedObjectUrl) return;

        const targetKb = Number.parseInt(wmTargetKbInput.value, 10);
        const safeTargetKb = Number.isFinite(targetKb) ? Math.max(30, Math.min(3000, targetKb)) : 300;
        wmTargetKbInput.value = String(safeTargetKb);

        const oldText = wmRunBtn.textContent;
        wmRunBtn.disabled = true;
        wmRunBtn.textContent = '处理中...';

        try {
          const output = await runPipeline(wmSelectedObjectUrl, safeTargetKb);

          if (wmResultObjectUrl) {
            URL.revokeObjectURL(wmResultObjectUrl);
          }
          wmResultObjectUrl = URL.createObjectURL(output.blob);

          const fallbackName = wmSelectedFile ? wmGetDefaultDownloadName(wmSelectedFile.name) : 'output';
          const baseName = wmSanitizeDownloadName(wmDownloadNameInput.value || fallbackName);
          const ext = wmMimeToExt(output.mimeType);

          const a = document.createElement('a');
          a.href = wmResultObjectUrl;
          a.download = `${baseName}.${ext}`;
          document.body.appendChild(a);
          a.click();
          a.remove();
        } catch (error) {
          console.error('[WatermarkTool] 处理失败:', error);
        } finally {
          wmRunBtn.textContent = oldText;
          wmRunBtn.disabled = !wmSelectedFile;
        }
      });

      window.addEventListener('beforeunload', () => {
        if (wmSelectedObjectUrl) URL.revokeObjectURL(wmSelectedObjectUrl);
        if (wmResultObjectUrl) URL.revokeObjectURL(wmResultObjectUrl);
      });

      ensureBgImages().catch((error) => {
        console.error('[WatermarkTool] 模板图加载失败:', error);
      });
    })();
  </script>
</body>
</html>

